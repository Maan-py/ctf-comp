#!/usr/bin/env python3
"""
Test script to understand server behavior
"""

import requests
import socket

HOST = "210.79.190.102"
PORT = 8081

def test_basic():
    """Test basic connectivity"""
    print("[*] Testing basic connectivity...")
    try:
        r = requests.get(f"http://{HOST}:{PORT}/", timeout=5)
        print(f"[+] Status: {r.status_code}")
        print(f"[+] Headers: {dict(r.headers)}")
        print(f"[+] Content length: {len(r.content)}")
    except Exception as e:
        print(f"[-] Error: {e}")

def test_flag_endpoint():
    """Test /flag endpoint"""
    print("\n[*] Testing /flag endpoint...")
    try:
        r = requests.get(f"http://{HOST}:{PORT}/flag", timeout=5)
        print(f"[+] Status: {r.status_code}")
        print(f"[+] Response: {r.text[:200]}")
    except Exception as e:
        print(f"[-] Error: {e}")

def test_content_endpoint():
    """Test /content endpoint"""
    print("\n[*] Testing /content endpoint...")
    try:
        # Test with valid hex
        r = requests.get(f"http://{HOST}:{PORT}/content/48656c6c6f", timeout=5)
        print(f"[+] Status: {r.status_code}")
        print(f"[+] Response: {r.text}")
        print(f"[+] Headers: {dict(r.headers)}")
    except Exception as e:
        print(f"[-] Error: {e}")

def test_chunked_request():
    """Test sending chunked request"""
    print("\n[*] Testing chunked request...")
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    
    try:
        sock.connect((HOST, PORT))
        
        # Send request with Transfer-Encoding: chunked
        request = b"""GET /content/48656c6c6f HTTP/1.1\r
Host: localhost\r
Transfer-Encoding: chunked\r
Connection: close\r
\r
0\r
\r
"""
        sock.send(request)
        
        response = b""
        while True:
            try:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
            except:
                break
        
        print(f"[+] Response:\n{response.decode('utf-8', errors='ignore')[:500]}")
        sock.close()
    except Exception as e:
        print(f"[-] Error: {e}")

def test_login():
    """Test login"""
    print("\n[*] Testing login...")
    try:
        session = requests.Session()
        r = session.post(
            f"http://{HOST}:{PORT}/login",
            data={"username": "admin", "password": "admin"},
            timeout=5
        )
        print(f"[+] Status: {r.status_code}")
        print(f"[+] Cookies: {dict(session.cookies)}")
        
        # Try to access flag
        r2 = session.get(f"http://{HOST}:{PORT}/flag", timeout=5)
        print(f"[+] Flag status: {r2.status_code}")
        print(f"[+] Flag response: {r2.text[:200]}")
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    print("=" * 70)
    print("Server Testing")
    print("=" * 70)
    
    test_basic()
    test_flag_endpoint()
    test_content_endpoint()
    test_chunked_request()
    test_login()



