#!/usr/bin/env python3
"""
Simple test to understand server behavior
"""

import requests
import socket

HOST = "210.79.190.102"
PORT = 8081

def test_with_requests_lib():
    """Test using requests library"""
    print("[*] Testing with requests library...")
    
    try:
        # Test basic endpoints
        r = requests.get(f"http://{HOST}:{PORT}/", timeout=5)
        print(f"[+] / -> {r.status_code}")
        
        r = requests.get(f"http://{HOST}:{PORT}/flag", timeout=5)
        print(f"[+] /flag -> {r.status_code}: {r.text[:100]}")
        
        r = requests.get(f"http://{HOST}:{PORT}/content/48656c6c6f", timeout=5)
        print(f"[+] /content/48656c6c6f -> {r.status_code}: {r.text}")
        
        # Try to login (we don't know credentials, but let's see what happens)
        r = requests.post(f"http://{HOST}:{PORT}/login", 
                         data={"username": "test", "password": "test"}, 
                         timeout=5)
        print(f"[+] POST /login -> {r.status_code}")
        print(f"[+] Cookies: {dict(r.cookies)}")
        
        # Try accessing flag with session
        if r.cookies:
            r2 = requests.get(f"http://{HOST}:{PORT}/flag", 
                            cookies=r.cookies, 
                            timeout=5)
            print(f"[+] /flag with cookies -> {r2.status_code}: {r2.text[:100]}")
        
    except Exception as e:
        print(f"[-] Error: {e}")

def test_raw_socket():
    """Test with raw socket to see exact HTTP response"""
    print("\n[*] Testing with raw socket...")
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    
    try:
        sock.connect((HOST, PORT))
        
        # Simple GET request
        request = b"""GET /content/48656c6c6f HTTP/1.1\r
Host: localhost\r
Connection: close\r
\r
"""
        
        sock.send(request)
        
        response = b""
        while True:
            try:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
            except:
                break
        
        print(f"[+] Response ({len(response)} bytes):")
        print(response.decode('utf-8', errors='ignore'))
        
        # Check for Transfer-Encoding header
        if b"Transfer-Encoding" in response or b"transfer-encoding" in response:
            print("[!] Response has Transfer-Encoding header!")
        
        sock.close()
        
    except Exception as e:
        print(f"[-] Error: {e}")

def test_chunked_request_detailed():
    """Test chunked request in detail"""
    print("\n[*] Testing chunked request in detail...")
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    
    try:
        sock.connect((HOST, PORT))
        
        # Send request with Transfer-Encoding: chunked
        # Chunked format: size in hex\r\ndata\r\n
        # Empty chunk to end: 0\r\n\r\n
        
        request = b"""GET /content/48656c6c6f HTTP/1.1\r
Host: localhost\r
Transfer-Encoding: chunked\r
Connection: close\r
\r
0\r
\r
"""
        
        print(f"[*] Sending request ({len(request)} bytes)...")
        print(f"[*] Request:\n{request.decode('utf-8', errors='ignore')}")
        
        sock.send(request)
        
        # Wait a bit
        import time
        time.sleep(0.5)
        
        response = b""
        try:
            while True:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
                if len(response) > 10000:
                    break
        except socket.timeout:
            pass
        except:
            pass
        
        print(f"[+] Response ({len(response)} bytes):")
        if response:
            print(response.decode('utf-8', errors='ignore')[:1000])
        else:
            print("[!] No response received!")
        
        sock.close()
        
    except Exception as e:
        print(f"[-] Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    print("=" * 70)
    print("Simple Server Tests")
    print("=" * 70)
    
    test_with_requests_lib()
    test_raw_socket()
    test_chunked_request_detailed()



