const puppeteer = require("puppeteer");

async function runLoginCheck() {
  const BASE_URL = process.env.BASE_URL || "http://localhost:8081";
  const USERNAME = process.env.USERNAME || "redacted";
  const PASSWORD = process.env.PASSWORD || "redacted";

  const browser = await puppeteer.launch({
    headless: true,
    args: [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-dev-shm-usage",
      "--disable-gpu",
      "--no-gpu",
      "--disable-default-apps",
      "--disable-translate",
      "--disable-device-discovery-notifications",
      "--disable-software-rasterizer",
      "--disable-xss-auditor",
    ],
  });

  try {
    const page = await browser.newPage();
    console.log("[*] Opening login page...");
    await page.goto(`${BASE_URL}/login`, { waitUntil: "networkidle2" });

    await page.type("input[name=username]", USERNAME);
    await page.type("input[name=password]", PASSWORD);
    await page.click("button[type=submit]");

    await page.waitForNavigation({ waitUntil: "networkidle2" });

    const url = page.url();
    if (url.includes("/dashboard")) {
      console.log("[+] Login success! Now at dashboard.");
    } else {
      console.log("[-] Login failed, still at:", url);
    }

    const content = await page.content();
    console.log("[*] Dashboard HTML length:", content.length);
  } catch (err) {
    console.error("[!] Error:", err.message);
  } finally {
    await browser.close();
  }
}

runLoginCheck();
setInterval(runLoginCheck, 5000);
