from flask import Flask, request, session, redirect, url_for, make_response, Response, render_template
from werkzeug.middleware.proxy_fix import ProxyFix
import os
import string

app = Flask(__name__)

_HEX = set(string.hexdigits)

app.secret_key = os.getenv("SECRET_KEY", "redacted")

FLAG = os.getenv("FLAG", "redacted")
USERNAME = os.getenv("USERNAME", "redacted")
PASSWORD = os.getenv("PASSWORD", "redacted")

app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_port=1)

app.config.update(
    SESSION_COOKIE_HTTPONLY=True,
    SESSION_COOKIE_SAMESITE="Lax",
    SESSION_COOKIE_SECURE=os.getenv("SESSION_COOKIE_SECURE", "false").lower() == "true",
)

def parse_hex_to_text(s: str):
    if s.startswith(("0x", "0X")):
        s = s[2:]
    if not s or (len(s) % 2 != 0) or any(c not in _HEX for c in s):
        return None
    try:
        b = bytes.fromhex(s)
        return b.decode("utf-8")
    except Exception:
        return None

@app.route("/")
def index():
    return render_template("index.html", user=session.get("user"))

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "GET":
        return render_template("login.html")
    payload = request.form if request.form else (request.get_json(silent=True) or {})
    username = payload.get("username", "")
    password = payload.get("password", "")

    if username == USERNAME and password == PASSWORD:
        session["user"] = USERNAME
        return redirect(url_for("dashboard"))
    return render_template("login.html", error="Invalid credentials"), 401

@app.route("/logout", methods=["POST"])
def logout():
    session.clear()
    return redirect(url_for("index"))

@app.route("/dashboard")
def dashboard():
    if not session.get("user"):
        return redirect(url_for("login"))
    return render_template("dashboard.html", user=session.get("user"))

@app.route("/flag")
def flag():
    if session.get("user"):
        return FLAG
    return make_response("Unauthorized", 401)

@app.route("/content/<anystring>", methods=["GET"])
def content(anystring: str):
    text = parse_hex_to_text(anystring)
    if text is None:
        return Response("Page error!", mimetype="text/plain; charset=utf-8", status=400)
    return Response(text, mimetype="text/plain; charset=utf-8")
