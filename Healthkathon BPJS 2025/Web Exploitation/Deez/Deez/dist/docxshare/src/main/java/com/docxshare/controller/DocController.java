package com.docxshare.controller;

import com.docxshare.model.DocumentWrapper;
import com.docxshare.model.StoredDoc;
import com.docxshare.security.WAF;
import com.docxshare.util.Base64Utils;
import com.docxshare.util.CookieUtils;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.io.ByteArrayInputStream;
import java.util.Base64;

@Controller
@RequestMapping("/docs")
public class DocController {

    private final ApiController apiController;

    public DocController(ApiController apiController) {
        this.apiController = apiController;
    }

    @GetMapping("/{uuid}")
    public String viewDoc(@PathVariable String uuid,
                          HttpServletRequest request,
                          Model model) throws Exception {
        StoredDoc stored = apiController.getDocument(uuid);
        if (stored == null) {
            model.addAttribute("error", "Document not found");
            return "error";
        }

        String cookieSignature = CookieUtils.getCookieValue(request, "signature");
        if (cookieSignature == null || !cookieSignature.equals(stored.getSignature())) {
            model.addAttribute("error", "Invalid or missing signature cookie!");
            return "error";
        }

        DocumentWrapper wrapper = stored.getWrapper();

        byte[] data = Base64.getDecoder().decode(wrapper.getMetadata());
        WAF ois = new WAF(new ByteArrayInputStream(data));
        Object obj = ois.readObject();
        ois.close();

        String content = Base64Utils.decodeToString(wrapper.getContent());

        model.addAttribute("filename", wrapper.getFilename());
        model.addAttribute("metadata", obj.toString());
        model.addAttribute("signature", stored.getSignature());
        model.addAttribute("content", content);

        return "doc"; 
    }
}
