package com.docxshare.security;

import java.io.IOException;
import java.io.InputStream;
import java.io.InvalidClassException;
import java.io.ObjectInputStream;
import java.io.ObjectStreamClass;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;

public class WAF extends ObjectInputStream {

    private static final Set<String> DENY_EXACT = new HashSet<>(Arrays.asList(
            "javax.management.BadAttributeValueExpException",
            "sun.reflect.annotation.AnnotationInvocationHandler",
            "com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl",
            "com.sun.rowset.JdbcRowSetImpl",
            "org.apache.commons.collections.functors.InvokerTransformer",
            "org.apache.commons.collections.functors.ChainedTransformer",
            "org.apache.commons.collections.map.LazyMap",
            "org.apache.commons.collections.keyvalue.TiedMapEntry",
            "org.apache.commons.collections4.functors.InvokerTransformer",
            "org.apache.commons.collections4.functors.ChainedTransformer",
            "org.apache.commons.collections4.map.LazyMap",
            "org.apache.commons.collections4.keyvalue.TiedMapEntry",
            "org.springframework.beans.factory.config.MethodInvokingFactoryBean",
            "org.springframework.context.support.FileSystemXmlApplicationContext",
            "org.codehaus.groovy.runtime.ConvertedClosure",
            "org.codehaus.groovy.runtime.MethodClosure",
            "com.mchange.v2.c3p0.JndiRefForwardingDataSource",
            "com.mchange.v2.c3p0.WrapperConnectionPoolDataSourceBase",
            "com.sun.syndication.feed.impl.ToStringBean"
    ));

    private static final String[] DENY_PREFIX = new String[] {
            "org.apache.commons.collections.",
            "org.apache.commons.collections4.",
            "org.codehaus.groovy.runtime.",
            "com.mchange.v2.c3p0.",
            "com.sun.syndication.",
            "org.springframework.beans.factory.",
            "org.springframework.context.support."
    };

    private static final String[] DENY_KEYWORD = new String[] {
            "TemplatesImpl",
            "InvokerTransformer",
            "ChainedTransformer",
            "LazyMap",
            "TiedMapEntry",
            "AnnotationInvocationHandler",
            "BadAttributeValueExpException",
            "MethodInvokingFactoryBean"
    };

    public WAF(InputStream in) throws IOException {
        super(in);
    }

    @Override
    protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
        String name = desc.getName();
        if (blocked(name)) {
            throw new InvalidClassException("Your action is blocked by WAF");
        }
        if (name.startsWith("[L") && name.endsWith(";")) {
            String element = name.substring(2, name.length() - 1);
            if (blocked(element)) {
                throw new InvalidClassException("Your action is blocked by WAF");
            }
        }
        return super.resolveClass(desc);
    }

    private boolean blocked(String name) {
        if (DENY_EXACT.contains(name)) return true;
        for (String p : DENY_PREFIX) if (name.startsWith(p)) return true;
        for (String k : DENY_KEYWORD) if (name.contains(k)) return true;
        return false;
    }
}
