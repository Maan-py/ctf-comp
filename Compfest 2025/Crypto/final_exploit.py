#!/usr/bin/env python3
"""
ğŸ£ Ayam Enak Sekali - Final Padding Oracle Exploit
This script will get the actual flag from the challenge
"""

import subprocess
import sys
import time
import re

def run_exploit():
    print("ğŸš€ Starting Padding Oracle Attack...")
    print("=" * 50)
    
    # Start the challenge server
    try:
        process = subprocess.Popen(
            [sys.executable, "chall-Ayam Enak Sekali copy.py"],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            bufsize=1
        )
        time.sleep(2)  # Wait for server to start
        
        print("âœ… Server started successfully")
        
        # Step 1: Get encrypted flag
        print("\nğŸ” Getting encrypted flag...")
        process.stdin.write("3\n")
        process.stdin.flush()
        time.sleep(0.5)
        
        # Read the banner and menu
        output = ""
        while True:
            char = process.stdout.read(1)
            if char == '>':
                break
            output += char
        
        # Read the hex output
        encrypted_flag_hex = process.stdout.readline().strip()
        print(f"ğŸ“¦ Encrypted flag: {encrypted_flag_hex}")
        
        # Step 2: Perform padding oracle attack
        print("\nğŸ”“ Starting padding oracle attack...")
        
        # Convert hex to bytes
        ct = bytes.fromhex(encrypted_flag_hex)
        iv = ct[:16]
        ciphertext = ct[16:]
        
        # Split into blocks
        blocks = [ciphertext[i:i+16] for i in range(0, len(ciphertext), 16)]
        print(f"ğŸ“¦ Number of blocks: {len(blocks)}")
        
        decrypted = b''
        
        for i, block in enumerate(blocks):
            print(f"\nğŸ”“ Decrypting block {i+1}/{len(blocks)}")
            prev_block = blocks[i-1] if i > 0 else iv
            
            # Decrypt this block
            decrypted_block = decrypt_block_with_oracle(process, block, prev_block)
            decrypted += decrypted_block
            print(f"  âœ… Block {i+1} decrypted: {decrypted_block}")
        
        # Remove PKCS7 padding
        padding_len = decrypted[-1]
        flag = decrypted[:-padding_len]
        
        print(f"\nğŸ‰ SUCCESS! Flag found: {flag.decode()}")
        return flag.decode()
        
    except Exception as e:
        print(f"âŒ Error: {e}")
        return None
    finally:
        if 'process' in locals():
            process.terminate()
            process.wait()

def decrypt_block_with_oracle(process, target_block, prev_block):
    """Decrypt a single block using padding oracle"""
    decrypted = b''
    
    for byte_pos in range(15, -1, -1):
        padding_len = 16 - byte_pos
        print(f"  ğŸ” Decrypting byte {byte_pos}, padding length: {padding_len}")
        
        # Set up the padding bytes we already know
        modified_prev = bytearray(prev_block)
        for i in range(byte_pos + 1, 16):
            modified_prev[i] = decrypted[15 - i] ^ padding_len
            
        # Try all possible values for current byte
        found = False
        for guess in range(256):
            modified_prev[byte_pos] = guess ^ padding_len
            
            # Create test ciphertext
            test_ct = bytes(modified_prev) + target_block
            test_ct_hex = test_ct.hex()
            
            # Test with oracle
            if test_padding_oracle(process, test_ct_hex):
                decrypted_byte = guess
                decrypted = bytes([decrypted_byte]) + decrypted
                print(f"    âœ… Found byte {byte_pos}: {decrypted_byte} (0x{decrypted_byte:02x})")
                found = True
                break
                
        if not found:
            print(f"    âš ï¸  Warning: No valid padding found for byte {byte_pos}")
            decrypted = bytes([0]) + decrypted
            
    return decrypted

def test_padding_oracle(process, ct_hex):
    """Test if ciphertext has valid padding using option 2"""
    # Send option 2
    process.stdin.write("2\n")
    process.stdin.flush()
    time.sleep(0.1)
    
    # Read menu
    while True:
        char = process.stdout.read(1)
        if char == '>':
            break
    
    # Send the ciphertext
    process.stdin.write(ct_hex + "\n")
    process.stdin.flush()
    time.sleep(0.1)
    
    # Read response
    response = ""
    while True:
        char = process.stdout.read(1)
        if char == '>':
            break
        response += char
    
    # Check if we got an error (invalid padding) or success
    return "Oops mesin pemecah telur rusak" not in response

if __name__ == "__main__":
    print("ğŸ£ Ayam Enak Sekali - Padding Oracle Exploit")
    print("=" * 50)
    
    flag = run_exploit()
    
    if flag:
        print(f"\nğŸ† FLAG BERHASIL DITEMUKAN!")
        print(f"ğŸ¯ Flag: {flag}")
    else:
        print("\nâŒ Gagal mendapatkan flag")
        print("ğŸ’¡ Coba jalankan manual:")
        print("1. python 'chall-Ayam Enak Sekali copy.py'")
        print("2. Pilih opsi 3 untuk dapat encrypted flag")
        print("3. Jalankan exploit script ini") 