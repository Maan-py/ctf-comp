from binascii import hexlify, unhexlify
import requests
import time

def test_padding_oracle(ct_hex):
    """Test if the ciphertext has valid padding"""
    try:
        # Simulate the server response
        # In a real scenario, you'd send this to the actual server
        # For now, we'll simulate the behavior
        ct = unhexlify(ct_hex)
        # This is a simplified test - in reality you'd need to interact with the server
        return True  # Assume valid for now
    except:
        return False

def padding_oracle_attack(encrypted_flag_hex):
    """Perform padding oracle attack to decrypt the flag"""
    ct = unhexlify(encrypted_flag_hex)
    iv = ct[:16]
    ciphertext = ct[16:]
    
    # Split into blocks
    blocks = [ciphertext[i:i+16] for i in range(0, len(ciphertext), 16)]
    
    decrypted = b''
    
    for block_idx in range(len(blocks)):
        current_block = blocks[block_idx]
        prev_block = blocks[block_idx - 1] if block_idx > 0 else iv
        
        # Decrypt current block
        decrypted_block = b''
        
        for byte_pos in range(15, -1, -1):
            # Try all possible values for this byte
            for guess in range(256):
                # Create modified previous block
                modified_prev = bytearray(prev_block)
                
                # Set padding bytes
                padding_len = 16 - byte_pos
                for i in range(byte_pos + 1, 16):
                    modified_prev[i] = decrypted_block[15 - i] ^ padding_len
                
                # Set current byte
                modified_prev[byte_pos] = guess ^ padding_len
                
                # Create test ciphertext
                test_ct = bytes(modified_prev) + current_block
                test_ct_hex = hexlify(test_ct).decode()
                
                # Test padding oracle
                if test_padding_oracle(test_ct_hex):
                    decrypted_byte = guess
                    decrypted_block = bytes([decrypted_byte]) + decrypted_block
                    break
            else:
                # If no valid padding found, try with different approach
                decrypted_byte = 0
                decrypted_block = bytes([decrypted_byte]) + decrypted_block
        
        decrypted += decrypted_block
    
    return decrypted

# For demonstration, let's create a simple test
# In reality, you'd need to interact with the actual server

print("Padding Oracle Attack Simulation")
print("Note: This is a demonstration. In a real scenario, you'd need to:")
print("1. Connect to the actual server")
print("2. Get the encrypted flag using option 3")
print("3. Use the padding oracle (option 2) to decrypt it")
print("4. Handle the actual server responses")

# Example of how the attack would work:
print("\nTo exploit this challenge:")
print("1. Use option 3 to get encrypted flag")
print("2. Use padding oracle attack on the encrypted flag")
print("3. The server's error handling reveals padding validity")
print("4. Decrypt the flag byte by byte using the oracle") 