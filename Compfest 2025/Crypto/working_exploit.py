import subprocess
import sys
import time
import re

class PaddingOracleExploit:
    def __init__(self, script_path):
        self.script_path = script_path
        self.process = None
        
    def start_server(self):
        """Start the challenge server"""
        try:
            self.process = subprocess.Popen(
                [sys.executable, self.script_path],
                stdin=subprocess.PIPE,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                bufsize=1
            )
            time.sleep(1)  # Give it time to start
            print("âœ… Server started successfully")
        except Exception as e:
            print(f"âŒ Failed to start server: {e}")
            return False
        return True
        
    def read_output(self):
        """Read all available output"""
        output = ""
        while True:
            if self.process.stdout.readable():
                char = self.process.stdout.read(1)
                if char == '':
                    break
                output += char
                if char == '>':
                    break
            else:
                break
        return output
        
    def send_command(self, command):
        """Send a command to the server"""
        if self.process is None:
            return None
        try:
            self.process.stdin.write(command + '\n')
            self.process.stdin.flush()
            time.sleep(0.1)
            return self.read_output()
        except Exception as e:
            print(f"âŒ Error sending command: {e}")
            return None
            
    def get_encrypted_flag(self):
        """Get the encrypted flag using option 3"""
        print("ğŸ” Getting encrypted flag...")
        self.send_command("3")
        output = self.read_output()
        
        # Extract the hex string from output
        lines = output.split('\n')
        for line in lines:
            if re.match(r'^[0-9a-f]+$', line.strip()):
                print(f"âœ… Got encrypted flag: {line.strip()}")
                return line.strip()
        
        print("âŒ Could not extract encrypted flag")
        return None
        
    def test_padding_oracle(self, ct_hex):
        """Test if ciphertext has valid padding using option 2"""
        self.send_command("2")
        self.read_output()  # Read menu
        
        self.send_command(ct_hex)
        output = self.read_output()
        
        # Check if we got an error (invalid padding) or success
        is_valid = "Oops mesin pemecah telur rusak" not in output
        return is_valid
        
    def decrypt_block(self, target_block, prev_block):
        """Decrypt a single block using padding oracle"""
        decrypted = b''
        
        for byte_pos in range(15, -1, -1):
            padding_len = 16 - byte_pos
            print(f"  ğŸ” Decrypting byte {byte_pos}, padding length: {padding_len}")
            
            # Set up the padding bytes we already know
            modified_prev = bytearray(prev_block)
            for i in range(byte_pos + 1, 16):
                modified_prev[i] = decrypted[15 - i] ^ padding_len
                
            # Try all possible values for current byte
            found = False
            for guess in range(256):
                modified_prev[byte_pos] = guess ^ padding_len
                
                # Create test ciphertext
                test_ct = bytes(modified_prev) + target_block
                test_ct_hex = test_ct.hex()
                
                # Test with oracle
                if self.test_padding_oracle(test_ct_hex):
                    decrypted_byte = guess
                    decrypted = bytes([decrypted_byte]) + decrypted
                    print(f"    âœ… Found byte {byte_pos}: {decrypted_byte} (0x{decrypted_byte:02x})")
                    found = True
                    break
                    
            if not found:
                print(f"    âš ï¸  Warning: No valid padding found for byte {byte_pos}")
                decrypted = bytes([0]) + decrypted
                
        return decrypted
        
    def decrypt_flag(self):
        """Decrypt the flag using padding oracle attack"""
        # Get encrypted flag
        encrypted_flag_hex = self.get_encrypted_flag()
        if not encrypted_flag_hex:
            return None
            
        # Convert hex to bytes
        ct = bytes.fromhex(encrypted_flag_hex)
        iv = ct[:16]
        ciphertext = ct[16:]
        
        # Split into blocks
        blocks = [ciphertext[i:i+16] for i in range(0, len(ciphertext), 16)]
        print(f"ğŸ“¦ Number of blocks: {len(blocks)}")
        
        decrypted = b''
        
        for i, block in enumerate(blocks):
            print(f"\nğŸ”“ Decrypting block {i+1}/{len(blocks)}")
            prev_block = blocks[i-1] if i > 0 else iv
            decrypted_block = self.decrypt_block(block, prev_block)
            decrypted += decrypted_block
            print(f"  ğŸ“ Block {i+1} decrypted: {decrypted_block}")
            
        return decrypted
        
    def close(self):
        """Close the server process"""
        if self.process:
            self.process.terminate()
            self.process.wait()
            print("ğŸ”’ Server closed")

# Main exploit
if __name__ == "__main__":
    print("ğŸ£ Padding Oracle Attack - Ayam Enak Sekali")
    print("=" * 50)
    
    exploit = PaddingOracleExploit("chall-Ayam Enak Sekali copy.py")
    
    try:
        print("ğŸš€ Starting padding oracle attack...")
        if exploit.start_server():
            # Get the flag
            flag = exploit.decrypt_flag()
            if flag:
                print(f"\nğŸ‰ SUCCESS! Decrypted flag: {flag.decode()}")
            else:
                print("âŒ Failed to decrypt flag")
        else:
            print("âŒ Failed to start server")
            
    except Exception as e:
        print(f"âŒ Error: {e}")
    finally:
        exploit.close() 