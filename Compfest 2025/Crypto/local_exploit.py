from binascii import hexlify, unhexlify
import subprocess
import sys
import time

class PaddingOracleExploit:
    def __init__(self, script_path):
        self.script_path = script_path
        self.process = None
        
    def start_server(self):
        """Start the challenge server"""
        self.process = subprocess.Popen(
            [sys.executable, self.script_path],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )
        time.sleep(0.1)  # Give it time to start
        
    def send_command(self, command):
        """Send a command to the server and get response"""
        if self.process is None:
            return None
            
        try:
            self.process.stdin.write(command + '\n')
            self.process.stdin.flush()
            
            # Read response
            response = ""
            while True:
                char = self.process.stdout.read(1)
                if char == '>':
                    break
                response += char
                
            return response.strip()
        except:
            return None
            
    def get_encrypted_flag(self):
        """Get the encrypted flag using option 3"""
        # Send option 3
        self.send_command("3")
        # Get the hex output
        response = self.process.stdout.readline().strip()
        return response
        
    def test_padding_oracle(self, ct_hex):
        """Test if ciphertext has valid padding using option 2"""
        # Send option 2
        self.send_command("2")
        # Send the ciphertext
        self.send_command(ct_hex)
        
        # Read response
        response = ""
        while True:
            char = self.process.stdout.read(1)
            if char == '>':
                break
            response += char
            
        # Check if we got an error (invalid padding) or success
        return "Oops mesin pemecah telur rusak" not in response
        
    def decrypt_block(self, target_block, prev_block):
        """Decrypt a single block using padding oracle"""
        decrypted = b''
        
        for byte_pos in range(15, -1, -1):
            padding_len = 16 - byte_pos
            
            # Set up the padding bytes we already know
            modified_prev = bytearray(prev_block)
            for i in range(byte_pos + 1, 16):
                modified_prev[i] = decrypted[15 - i] ^ padding_len
                
            # Try all possible values for current byte
            for guess in range(256):
                modified_prev[byte_pos] = guess ^ padding_len
                
                # Create test ciphertext
                test_ct = bytes(modified_prev) + target_block
                test_ct_hex = hexlify(test_ct).decode()
                
                # Test with oracle
                if self.test_padding_oracle(test_ct_hex):
                    decrypted = bytes([guess]) + decrypted
                    break
            else:
                # If no valid padding found, this shouldn't happen
                print(f"Warning: No valid padding found for byte {byte_pos}")
                decrypted = bytes([0]) + decrypted
                
        return decrypted
        
    def decrypt_flag(self):
        """Decrypt the flag using padding oracle attack"""
        # Get encrypted flag
        encrypted_flag_hex = self.get_encrypted_flag()
        print(f"Encrypted flag: {encrypted_flag_hex}")
        
        ct = unhexlify(encrypted_flag_hex)
        iv = ct[:16]
        ciphertext = ct[16:]
        
        # Split into blocks
        blocks = [ciphertext[i:i+16] for i in range(0, len(ciphertext), 16)]
        
        decrypted = b''
        
        for i, block in enumerate(blocks):
            prev_block = blocks[i-1] if i > 0 else iv
            decrypted_block = self.decrypt_block(block, prev_block)
            decrypted += decrypted_block
            
        return decrypted
        
    def close(self):
        """Close the server process"""
        if self.process:
            self.process.terminate()
            self.process.wait()

# Main exploit
if __name__ == "__main__":
    exploit = PaddingOracleExploit("chall-Ayam Enak Sekali copy.py")
    
    try:
        print("Starting padding oracle attack...")
        exploit.start_server()
        
        # Get the flag
        flag = exploit.decrypt_flag()
        print(f"Decrypted flag: {flag.decode()}")
        
    except Exception as e:
        print(f"Error: {e}")
    finally:
        exploit.close() 