from math import isqrt, gcd
from Crypto.Util.number import long_to_bytes

# ===== paste dari chall =====
N = int("""470821275378622766548406379880529338794133174017836532359465458842978250288195496903737701018708389607395926375764495252249524485721437206404657505602717378797817059129927994291010298775333960960876331865795702359353831193716780067883300014190263790025656721006673204126318211358981452766387958540313021833728316544474893933784196613668703923064766651230224226496804133943877925823744475642539182849933566549964770222695043872255922447331084014029344599753753361668309455452067364379269019829348877019838735059468874460522720311085526106704975874603665929577025357560706903511965464535476645174322959762616754604627904308846711938521349780719072773252038983564577438501868355236878427975188804280994378882026421063060618381591385956922699468962959521664767912845594578854634478177774772051373086589060227920429085066056508712087913638889142464231364020024754983891066797958200151403199524417399961022309888397869311009009407540441815215282977799623237820542957224499202135491963349145330438107763851239887862854419169209510943982151843142689050711455970069008450622752498876284862924908532787922322443618309807758926085987463348187730672230220945654333150921908087851781569539929841575242206000629124465147791865319440057341095950537""")
e = int("""168340407187448780533121359192774543592433312696547352604945589760959729025286813068810686374375564332820868778111025992262794538362804908019388361331063935154313327097246352716642023238834017407035090961903771659072724196119133767487197566721860873866692416039831326074441281642686765260568388624499185539015231938908961569483740494018235696384877374459031962941503977262811279744574738229769170853464775654271434117524768629231933541738545524664482623011218987828114715553354397196818766878975056941154984953305585904305677648554584999095116193618473250769909056676219387356131276572972206114917093108967146907031250063972865105325721297313510887354839722308410504403250804835243963249380804785449794467661454191511282456498402852367673515044029747135699678066038518395270835729912314443548852422480507807882301109486616492931389997293465688972399849293091153232114516157337198868256224531843017361751026974867772663637877523444301673930493768971916436464729987089423030872476810619894168834012505273887240793492990869592332406576101811758344033955785500667653357933912020382580856592588705800027341611270886481470599783284564709042799855160682171153014919102204811855918421975898313176344889107544377514397873821382148886528604175547451170284661788783347868292678135536602272959920669028163889259094317908761435249818521161769594561325259026063796080353791176479299168325194957449079609673016839054848457794940419070750567521470074016083903047155269117790362252680364950208093318982735438371016004696203119083441475208340696240067566174431071563880324803959677537839452663680972249632186783498401155175082228998440074381655006063588595866703675816901409656812634014018788929449594434751918321640092898001707971238372357144849965173964341762886105363455940058163191155541104011518106790977654234839810550832577793321271947841286390439141857727800772390385835412727062240159011292951826333192609485894637374676433179768288575951430713976701589314704808613151790917275941375288826310686551871354746056027286476121233151489301632998730747915100683258220277570300623172907901924147909863028464993501393884668637149596608131427729772733719843843369054827300194946318645272055114589805117144969126469808802544685350312999804370783084189397141899067637388547103966253472696692768588587036624155891915738275368565961619059351494634173644001045378878054883791360088264756823062229364831426024806255536953992837444545442100289225287323808288686235275616831300189370947232533""")
ct = int("""38372029715446104323233474226130005677791235547372411196562675297894471204646715231453544450104288853927743557955700165657574545490084691123597984613439961984218419418501484116047309068975602818432741291608359920463374017169885264334734129675764380843677195831954409317554082026603936380382891354906244689116917893079070283357729481871705424135397599014189662786326451809185488102617674938149892226340988764416089080133882745243695016491631860370137206715285012921703064293718169620746576492736940228082332240374597222297132762655332005330373506990299936725598038558809656767962269978159969438641809316440261284181944287848493691685466089727442088384153657077754599926577229929659512556918293769466743779411379853327820298428285342462430705709318354578790963211320273689618127875465341664349478432005393649925595399163649679853977779723120631476055523351744127847868806387353428928615634353380271036345436919064204755521023707211933717059209174970173646497726704693407777862517862011884520154308625895456120585531901465281193504267418053775560651195271548616855959844154952318817477468252468462417015619003108267158306511933280784855105403051681372499339303294535336487585479519348783921848477490761624859442733623797474330283561064""")

def is_square(n: int) -> bool:
    if n < 0:
        return False
    r = isqrt(n)
    return r*r == n

def try_candidate_phi(phi_prime: int):
    # Check (N+1)^2 - phi' == (p+q)^2 and recover p,q
    Delta = (N + 1)**2 - phi_prime
    if not is_square(Delta):
        return None
    S = isqrt(Delta)   # p+q
    D = S*S - 4*N      # (p-q)^2
    if not is_square(D):
        return None
    t = isqrt(D)
    p = (S + t)//2
    q = (S - t)//2
    if p*q == N and p>1 and q>1:
        return p, q
    return None

def solve():
    # r ≈ ((N-1)^2)/e  (≈ 1–3 di instance ini)
    r0 = ((N-1)**2) // e
    tried = set()
    # Kandidat r yang paling mungkin terlebih dulu
    r_candidates = list(range(max(1, r0-50), r0+51)) + list(range(1, 2000))
    for r in r_candidates:
        if r in tried: 
            continue
        tried.add(r)
        v = e*r + 1
        # k ≈ v / (N-1)^2, coba beberapa tetangga
        k0 = max(1, v // ((N-1)**2))
        for k in range(max(1, k0-2000), k0+2001):
            if v % k: 
                continue
            phi_prime = v // k
            rec = try_candidate_phi(phi_prime)
            if rec:
                p, q = rec
                # d = φ' - r (sesuai cara generate)
                d = phi_prime - r
                # verifikasi
                assert (e*d) % phi_prime == 1
                m = pow(ct, d, N)
                return long_to_bytes(m), p, q, r, k
    # Jika belum ketemu, perluas jangkauan agresif:
    for r in range(2000, 200000):
        v = e*r + 1
        k0 = max(1, v // ((N-1)**2))
        for k in range(max(1, k0-5), k0+6):
            if v % k: 
                continue
            phi_prime = v // k
            rec = try_candidate_phi(phi_prime)
            if rec:
                p, q = rec
                d = phi_prime - r
                assert (e*d) % phi_prime == 1
                m = pow(ct, d, N)
                return long_to_bytes(m), p, q, r, k
    raise RuntimeError("Belum ketemu; perluas range r/k lagi.")

flag, p, q, r, k = solve()
print("r =", r, "k =", k)
print("p bits:", p.bit_length(), "q bits:", q.bit_length())
print("FLAG =", flag)
